<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0ea5e9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ìœ ë¼ëŠ” ì§€í˜œì˜ ìˆ² ğŸŒ³</title>
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="apple-touch-icon" href="roopy_succ.jpeg">
    <link rel="icon" href="roopy_succ.jpeg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind ì„¤ì • ì»¤ìŠ¤í„°ë§ˆì´ì§•
        tailwind.config = {
            theme: {
                screens: {
                    'sm': '640px',
                    'md': '768px',
                    'lg': '1024px',
                    'xl': '1280px',
                    '2xl': '1536px',
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="yura-save-system.js"></script>
    <style>
        /* ì‚¬ìš©ì ì •ì˜ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }
        
        /* iOS ê¸°ê¸°ì—ì„œ input í•„ë“œ ì¤Œì¸ ë°©ì§€ */
        @supports (-webkit-touch-callout: none) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
        
        /* --- ëª¨ë°”ì¼ ì „ìš© ìŠ¤íƒ€ì¼ (767px ì´í•˜) --- */
        @media screen and (max-width: 767px) {
            .main-button {
                @apply h-40; /* ëª¨ë°”ì¼ì—ì„œ ë²„íŠ¼ ë†’ì´ ì¶•ì†Œ */
            }
            
            #home-screen main {
                @apply grid-cols-1 gap-4; /* í™ˆ í™”ë©´ì„ 1ì—´ ê·¸ë¦¬ë“œë¡œ ë³€ê²½ */
            }
            
            .modal-grid {
                @apply grid-cols-1; /* ëª¨ë‹¬ ë‚´ë¶€ ê·¸ë¦¬ë“œë¥¼ 1ì—´ë¡œ ë³€ê²½ */
            }
            
            #problem-container .grid {
                @apply grid-cols-1; /* ë¬¸ì œ ì„ íƒì§€ë¥¼ 1ì—´ë¡œ ë³€ê²½ */
            }
        }
        
        /* --- íƒœë¸”ë¦¿/ì•„ì´íŒ¨ë“œ ë° PC ê³µí†µ ìŠ¤íƒ€ì¼ (768px ì´ìƒ) --- */
        /* ì´ ë¶€ë¶„ì´ ì•„ì´íŒ¨ë“œì—ì„œ PCì²˜ëŸ¼ ë³´ì´ê²Œ í•˜ëŠ” í•µì‹¬ì…ë‹ˆë‹¤. */
        @media screen and (min-width: 768px) {
            /* ë ˆì´ì•„ì›ƒ ê³ ì • */
            .container {
                max-width: 1024px !important;
                width: 100% !important;
                padding: 16px !important;
            }
            
            #home-screen main {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important; /* 3ì—´(ìœ—ì¤„ 3ê°œ + ì•„ë«ì¤„ 3ê°œ) */
                gap: 1.5rem !important;
            }
            
            .main-button {
                @apply h-48; /* ë²„íŠ¼ ë†’ì´ë¥¼ PCì™€ ë™ì¼í•˜ê²Œ ì„¤ì • */
                width: 100% !important;
            }
            
            /* í…ìŠ¤íŠ¸ í¬ê¸°ë¥¼ PCì™€ ë™ì¼í•˜ê²Œ ê³ ì • */
            .text-4xl { font-size: 2.25rem !important; line-height: 2.5rem !important; }
            .text-3xl { font-size: 1.875rem !important; line-height: 2.25rem !important; }
            .text-2xl { font-size: 1.5rem !important; line-height: 2rem !important; }
            .text-xl { font-size: 1.25rem !important; line-height: 1.75rem !important; }
            .text-lg { font-size: 1.125rem !important; line-height: 1.75rem !important; }
            
            /* íŒ¨ë”©ì„ PCì™€ ë™ì¼í•˜ê²Œ ê³ ì • */
            .p-8 { padding: 2rem !important; }
            .p-6 { padding: 1.5rem !important; }
            .p-4 { padding: 1rem !important; }
            
            /* ëª¨ë‹¬ ì°½ í¬ê¸°ë¥¼ PCì™€ ë™ì¼í•˜ê²Œ ìœ ì§€ */
            #week-setup-modal .max-w-2xl,
            #stats-modal .max-w-2xl {
                max-width: 42rem !important;
            }
            
            /* ë²„íŠ¼ í¬ê¸°ë¥¼ PCì™€ ë™ì¼í•˜ê²Œ ìœ ì§€ */
            .btn {
                font-size: 1rem !important;
            }
            
            /* ë¬¸ì œ í‘œì‹œ ì˜ì—­ ë†’ì´ ê³ ì • */
            #problem-container {
                min-height: 20rem !important;
                max-height: 70vh;
                overflow-y: auto;
            }
            
            /* ì…ë ¥ í•„ë“œ í°íŠ¸ í¬ê¸° ê³ ì • (iOS ì¤Œ ë°©ì§€) */
            input[type="text"],
            input[type="number"],
            input[type="password"],
            select {
                font-size: 16px !important;
                padding: 0.5rem 0.75rem !important;
            }
            
            /* ëª¨ë‹¬ ë° ë¬¸ì œ ì˜µì…˜ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ ê³ ì • */
            .modal-grid, 
            #reward-inputs > div {
                display: grid !important;
                grid-template-columns: repeat(4, 1fr) !important; /* ë³´ìƒ ì„¤ì • ê·¸ë¦¬ë“œë¥¼ 4ì—´(ë³´ìƒ / ì˜ì–´ / í•œê¸€ / ìˆ˜í•™)ë¡œ ê³ ì • */
                gap: 0.75rem !important;
            }

            /* ë³´ìƒ ì„¤ì • ì˜ì—­: ë¼ë²¨ ì¤„ë°”ê¿ˆ ë°©ì§€ ë° ì…ë ¥ í¬ê¸° ì¡°ì • */
            #week-setup-modal label { white-space: nowrap; }
            #week-setup-modal .reward-desc { width: 100%; }
            #week-setup-modal input[type=number] { width: 100%; }
            
            #problem-container .grid,
            .options-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important; /* ë¬¸ì œ ì„ íƒì§€ë¥¼ 2ì—´ë¡œ ê³ ì • */
                gap: 1rem !important;
            }
            
            /* ì•„ì´ì½˜ ë° ì œëª© í¬ê¸°ë¥¼ PCì™€ ë™ì¼í•˜ê²Œ ê³ ì • */
            .subject-icon { font-size: 3.75rem !important; line-height: 1 !important; }
            .subject-title { font-size: 1.5rem !important; line-height: 2rem !important; }
        }

        .main-button {
            @apply w-full h-48 bg-white rounded-2xl shadow-lg flex flex-col justify-center items-center cursor-pointer transition-transform duration-300 hover:scale-105 hover:shadow-xl;
        }
        .subject-icon {
            @apply text-6xl mb-4;
        }
        .subject-title {
            @apply text-2xl font-bold text-gray-700;
        }
        .english-question-text {
            font-size: 1rem !important;  /* Standard readable size (16px) */
            line-height: 1.5rem !important;
            text-align: left;
            max-height: 50vh;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        .btn {
            @apply px-6 py-2 rounded-lg font-bold text-white transition-colors duration-300 disabled:bg-gray-400;
        }
        .btn-blue { @apply bg-blue-500 hover:bg-blue-600; }
        .btn-green { @apply bg-green-500 hover:bg-green-600; }
        .btn-gray { @apply bg-gray-500 hover:bg-gray-600; }
        .btn-orange { @apply bg-orange-500 hover:bg-orange-600; }
        .btn-red { @apply bg-red-500 hover:bg-red-600; }
        .btn-purple { @apply bg-purple-500 hover:bg-purple-600; }
        
        /* New button styles for problem navigation */
        .btn-next { @apply bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white shadow-lg; }
        .btn-save { @apply bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-gray-900 font-bold shadow-lg; }
        .btn-solution { @apply bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white shadow-lg; }
        
        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #3498db;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen overflow-x-hidden">

    <div class="container mx-auto p-4 max-w-4xl w-full">
        
        <div id="save-indicator" class="fixed top-4 right-4 bg-green-100 border border-green-400 text-green-700 px-4 py-2 rounded-lg shadow-lg hidden">
            ğŸ’¾ ìë™ ì €ì¥ë¨
        </div>

        <div id="login-screen">
             <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">ìœ ë¼ëŠ” ì§€í˜œì˜ ìˆ² ğŸŒ³</h1>
                <p class="text-lg text-gray-600 mb-8">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê³  ëª¨í—˜ì„ ì‹œì‘í•´ë´ìš”!</p>
                <div class="max-w-sm mx-auto">
                    <input type="password" id="password-input" class="w-full p-3 border-2 rounded-lg text-center text-xl mb-4" placeholder="ë¹„ë°€ë²ˆí˜¸">
                    <button id="login-button" class="btn btn-blue w-full text-lg">ì…ì¥í•˜ê¸°</button>
                    <p id="login-error" class="text-red-500 h-6 mt-2"></p>
                </div>
            </div>
        </div>


        <div id="home-screen" class="hidden">
            <header class="text-center mb-8">
                <h1 class="text-4xl font-bold text-gray-800">ì§€í˜œì˜ ìˆ² ğŸŒ³</h1>
                <p class="text-lg text-gray-600 mt-2">AIì™€ í•¨ê»˜í•˜ëŠ” ì´ˆë“± 4í•™ë…„ ì˜ì–´, í•œê¸€, ìˆ˜í•™ í•™ìŠµ</p>
                <p id="last-save-time" class="text-sm text-gray-500 mt-1"></p>
            </header>

            <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800">ì´ë²ˆ ì£¼ ëª©í‘œ ğŸ†</h3>
                        <p id="week-duration" class="text-sm text-gray-500"></p>
                        <p id="days-remaining" class="text-xs text-gray-400 mt-1"></p>
                    </div>
                    <div class="text-right">
                        <p class="text-lg font-bold text-blue-600">ì´ë²ˆ ì£¼ ì´ ì ìˆ˜</p>
                        <p id="weekly-score" class="text-4xl font-bold text-blue-600">0</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4 mb-4 p-3 bg-yellow-50 rounded-lg">
                    <label class="font-bold text-gray-700">ì˜ì–´ ë‚œì´ë„:</label>
                    <select id="english-level-select" class="px-3 py-1 border-2 rounded-lg font-bold">
                        <option value="1">ë ˆë²¨ 1</option>
                        <option value="2">ë ˆë²¨ 2</option>
                        <option value="3">ë ˆë²¨ 3</option>
                        <option value="4">ë ˆë²¨ 4</option>
                        <option value="5" selected>ë ˆë²¨ 5 (FAST ELA)</option>
                    </select>
                    <label class="font-bold text-gray-700">ìˆ˜í•™ ë‚œì´ë„:</label>
                    <select id="math-level-select" class="px-3 py-1 border-2 rounded-lg font-bold">
                        <option value="1">ë ˆë²¨ 1</option>
                        <option value="2">ë ˆë²¨ 2</option>
                        <option value="3">ë ˆë²¨ 3</option>
                        <option value="4">ë ˆë²¨ 4</option>
                        <option value="5">ë ˆë²¨ 5</option>
                        <option value="6">ë ˆë²¨ 6</option>
                        <option value="7">ë ˆë²¨ 7</option>
                        <option value="8">ë ˆë²¨ 8</option>
                        <option value="9">ë ˆë²¨ 9</option>
                        <option value="10">ë ˆë²¨ 10</option>
                    </select>
                </div>
                 <div id="subject-scores-home" class="flex justify-end gap-4 mb-4 text-right">
                    </div>
                <div id="weekly-goals-container" class="space-y-3">
                    </div>
                <button id="start-new-week-button" class="btn btn-green w-full mt-6">ìƒˆë¡œìš´ ì£¼ ì„¤ì •í•˜ê¸°</button>
                
                <button id="home-stats-button" class="btn btn-orange w-full mt-4">ğŸ“Š í•™ìŠµ í†µê³„ ë³´ê¸°</button>
            </div>


            <main class="grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-8">
                <div id="start-english" class="main-button">
                    <div class="subject-icon">EN</div>
                    <div class="subject-title">ì˜ì–´</div>
                </div>
                <div id="start-korean" class="main-button">
                    <div class="subject-icon">ğŸ“</div>
                    <div class="subject-title">í•œê¸€</div>
                </div>
                <div id="start-math" class="main-button">
                    <div class="subject-icon">ğŸ§®</div>
                    <div class="subject-title">ìˆ˜í•™</div>
                </div>
                 <div id="start-review" class="main-button">
                    <div class="subject-icon">ğŸ“–</div>
                    <div class="subject-title">ì˜¤ë‹µ ë…¸íŠ¸</div>
                </div>
                <div id="start-saved" class="main-button">
                    <div class="subject-icon">ğŸ”–</div>
                    <div class="subject-title">ì €ì¥í•œ ë¬¸ì œ</div>
                </div>
                <div id="start-vocabulary" class="main-button">
                    <div class="subject-icon">ğŸ“š</div>
                    <div class="subject-title">ë‹¨ì–´ì¥</div>
                </div>
            </main>
        </div>

        <div id="learning-screen" class="hidden bg-white p-8 rounded-2xl shadow-lg relative max-h-[90vh] overflow-y-auto">
            <div id="feedback-overlay" class="hidden absolute inset-0 bg-black bg-opacity-85 flex justify-center items-center z-10">
                <div id="feedback-content" class="text-2xl font-bold text-center bg-white p-8 rounded-2xl shadow-2xl max-w-lg"></div>
            </div>
            <div id="solution-overlay" class="hidden absolute inset-0 bg-black bg-opacity-75 flex justify-center items-center z-20 p-8">
                <div id="solution-content" class="bg-white p-8 rounded-lg shadow-xl text-lg text-gray-800 relative max-w-2xl w-full">
                    <button id="close-solution-overlay" class="absolute top-2 right-4 text-3xl text-gray-500 hover:text-gray-800">&times;</button>
                    <div id="solution-text"></div>
                </div>
            </div>

            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 id="subject-header" class="text-3xl font-bold text-blue-600"></h2>
                <div class="flex items-center gap-4">
                    <div id="learning-subject-scores" class="flex gap-4 text-lg font-bold">
                        </div>
                    <button id="stats-button" class="btn btn-orange">ğŸ“Š í†µê³„ ë³´ê¸°</button>
                    <button id="home-button" class="btn btn-gray">ğŸ¡ ì²˜ìŒìœ¼ë¡œ</button>
                </div>
            </div>

            <div id="english-info" class="hidden justify-between items-center mb-2 text-lg">
                <div id="english-difficulty-display" class="font-bold text-purple-600 bg-purple-100 px-4 py-1 rounded-full">ë‚œì´ë„: 1</div>
            </div>
            <div id="math-info" class="hidden justify-between items-center mb-2 text-lg">
                <div id="math-difficulty-display" class="font-bold text-yellow-600 bg-yellow-100 px-4 py-1 rounded-full">ë‚œì´ë„: 1</div>
                <div id="math-score-display" class="font-bold text-green-600 bg-green-100 px-4 py-1 rounded-full">ë§ì€ ê°œìˆ˜: 0</div>
            </div>
             <div id="current-problem-score-container" class="text-center mb-4 text-lg text-gray-600 font-bold h-7"></div>

            <div id="problem-container" class="min-h-[20rem] flex justify-center items-center">
                </div>

            <div id="action-buttons" class="mt-8 flex justify-around items-center">
                </div>
        </div>

        <!-- Vocabulary Screen -->
        <div id="vocabulary-screen" class="hidden bg-white p-8 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-3xl font-bold text-purple-600">ğŸ“š ë‚˜ì˜ ë‹¨ì–´ì¥</h2>
                <div class="flex items-center gap-4">
                    <div class="text-lg">
                        <span class="font-bold text-gray-600">ì´ ë‹¨ì–´:</span>
                        <span id="total-words" class="text-purple-600 font-bold">0</span>
                    </div>
                    <button id="vocab-home-button" class="btn btn-gray">ğŸ¡ ì²˜ìŒìœ¼ë¡œ</button>
                </div>
            </div>
            
            <!-- Search and Filter -->
            <div class="flex gap-4 mb-6">
                <input type="text" id="vocab-search" placeholder="ë‹¨ì–´ ê²€ìƒ‰..." 
                       class="flex-1 p-3 border-2 rounded-lg text-lg">
                <select id="vocab-filter" class="p-3 border-2 rounded-lg text-lg">
                    <option value="all">ëª¨ë“  ì¹´í…Œê³ ë¦¬</option>
                    <option value="Informational Text">Informational Text</option>
                    <option value="Advanced Vocabulary">Advanced Vocabulary</option>
                    <option value="Reading Across Genres">Reading Across Genres</option>
                    <option value="Main Idea">Main Idea</option>
                    <option value="Author's Purpose">Author's Purpose</option>
                    <option value="Text Evidence">Text Evidence</option>
                    <option value="Compare and Contrast">Compare and Contrast</option>
                </select>
            </div>
            
            <!-- Vocabulary Cards Container -->
            <div id="vocabulary-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto">
                <!-- Cards will be inserted here -->
            </div>
            
            <!-- Empty State -->
            <div id="vocab-empty-state" class="hidden text-center py-12">
                <div class="text-6xl mb-4">ğŸ“</div>
                <p class="text-xl text-gray-600">ì•„ì§ ì €ì¥ëœ ë‹¨ì–´ê°€ ì—†ì–´ìš”!</p>
                <p class="text-lg text-gray-500 mt-2">ì˜ì–´ ë¬¸ì œë¥¼ í’€ë©´ ìë™ìœ¼ë¡œ ë‹¨ì–´ê°€ ì €ì¥ë©ë‹ˆë‹¤.</p>
            </div>
        </div>

    </div>

    <div id="week-setup-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full">
            <div id="week-setup-form">
                <h2 class="text-3xl font-bold text-center mb-2 text-gray-800">ì´ë²ˆ ì£¼ ë³´ìƒ ì„¤ì •í•˜ê¸°</h2>
                <p class="text-center text-gray-500 mb-4">ì˜ì–´, í•œê¸€, ìˆ˜í•™ ì ìˆ˜ë¥¼ ëª¨ë‘ ë„˜ì–´ì•¼ ë³´ìƒì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”!</p>
                <p id="modal-message" class="text-center text-red-500 mb-4 font-bold h-6"></p>
                <div id="reward-inputs">
                    <!-- Header row (desktop) -->
                    <div class="hidden md:grid grid-cols-4 text-sm font-bold text-gray-600 mb-2 px-1">
                        <div>ë³´ìƒ ë‚´ìš©</div>
                        <div class="text-center text-purple-600">ì˜ì–´ ëª©í‘œ</div>
                        <div class="text-center text-cyan-600">í•œê¸€ ëª©í‘œ</div>
                        <div class="text-center text-yellow-600">ìˆ˜í•™ ëª©í‘œ</div>
                    </div>
                    <!-- Reward rows: 4 columns (desc / english / korean / math) -->
                    <div class="modal-grid grid grid-cols-1 md:grid-cols-4 items-center mb-4">
                        <input type="text" placeholder="ë³´ìƒ ë‚´ìš© (ì˜ˆ: ëƒ‰ì¥ê³ ë¥¼ ë¶€íƒí•´ ë³´ê¸°)" class="reward-desc p-2 border-2 rounded-lg" aria-label="ë³´ìƒ ë‚´ìš©">
                        <input type="number" placeholder="ì˜ì–´" class="reward-goal-english p-2 border-2 rounded-lg text-center" aria-label="ì˜ì–´ ëª©í‘œ" value="300">
                        <input type="number" placeholder="í•œê¸€" class="reward-goal-korean p-2 border-2 rounded-lg text-center" aria-label="í•œê¸€ ëª©í‘œ" value="300">
                        <input type="number" placeholder="ìˆ˜í•™" class="reward-goal-math p-2 border-2 rounded-lg text-center" aria-label="ìˆ˜í•™ ëª©í‘œ" value="300">
                    </div>
                    <div class="modal-grid grid grid-cols-1 md:grid-cols-4 items-center mb-4">
                        <input type="text" placeholder="ë³´ìƒ ë‚´ìš© (ì˜ˆ: ì›í•˜ëŠ” ì±… ì‚¬ê¸°)" class="reward-desc p-2 border-2 rounded-lg" aria-label="ë³´ìƒ ë‚´ìš©">
                        <input type="number" placeholder="ì˜ì–´" class="reward-goal-english p-2 border-2 rounded-lg text-center" aria-label="ì˜ì–´ ëª©í‘œ" value="500">
                        <input type="number" placeholder="í•œê¸€" class="reward-goal-korean p-2 border-2 rounded-lg text-center" aria-label="í•œê¸€ ëª©í‘œ" value="500">
                        <input type="number" placeholder="ìˆ˜í•™" class="reward-goal-math p-2 border-2 rounded-lg text-center" aria-label="ìˆ˜í•™ ëª©í‘œ" value="500">
                    </div>
                    <div class="modal-grid grid grid-cols-1 md:grid-cols-4 items-center mb-6">
                        <input type="text" placeholder="ë³´ìƒ ë‚´ìš© (ì˜ˆ: Roblox 1 hour)" class="reward-desc p-2 border-2 rounded-lg" aria-label="ë³´ìƒ ë‚´ìš©">
                        <input type="number" placeholder="ì˜ì–´" class="reward-goal-english p-2 border-2 rounded-lg text-center" aria-label="ì˜ì–´ ëª©í‘œ" value="1000">
                        <input type="number" placeholder="í•œê¸€" class="reward-goal-korean p-2 border-2 rounded-lg text-center" aria-label="í•œê¸€ ëª©í‘œ" value="1000">
                        <input type="number" placeholder="ìˆ˜í•™" class="reward-goal-math p-2 border-2 rounded-lg text-center" aria-label="ìˆ˜í•™ ëª©í‘œ" value="1000">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="save-week-button" class="btn btn-blue flex-1 text-lg">ì €ì¥í•˜ê³  ìƒˆë¡œìš´ ì£¼ ì‹œì‘!</button>
                    <button id="cancel-week-button" class="btn btn-gray">ì·¨ì†Œ</button>
                </div>
            </div>
            <div id="week-setup-success" class="hidden text-center">
                <h2 class="text-3xl font-bold text-green-600">ì €ì¥ ì™„ë£Œ!</h2>
                <p class="mt-4">ìƒˆë¡œìš´ ì£¼ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦ê²ê²Œ í•™ìŠµí•´ë´ìš”!</p>
            </div>
        </div>
    </div>

    <div id="stats-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full relative">
            <button id="close-stats-modal" class="absolute top-4 right-4 text-3xl text-gray-500 hover:text-gray-800">&times;</button>
            <h2 class="text-3xl font-bold text-center mb-6 text-gray-800">í•™ìŠµ í†µê³„</h2>
            <div id="stats-container" class="space-y-6 max-h-[60vh] overflow-y-auto"></div>
            <button id="reset-stats-button" class="btn btn-red w-full mt-4">í†µê³„ ì´ˆê¸°í™”</button>
        </div>
    </div>


    <script>
        // Register service worker for PWA (works when served over HTTPS or localhost)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').catch(err => {
                    console.warn('ServiceWorker registration failed:', err);
                });
            });
        }

        // DOM ìš”ì†Œ
        const loginScreen = document.getElementById('login-screen');
        const passwordInput = document.getElementById('password-input');
        const loginButton = document.getElementById('login-button');
        const loginError = document.getElementById('login-error');
        const homeScreen = document.getElementById('home-screen');
        const learningScreen = document.getElementById('learning-screen');
        const startEnglishBtn = document.getElementById('start-english');
        const startKoreanBtn = document.getElementById('start-korean');
        const startMathBtn = document.getElementById('start-math');
    const startReviewBtn = document.getElementById('start-review');
    const startSavedBtn = document.getElementById('start-saved');
        const startVocabularyBtn = document.getElementById('start-vocabulary');
        const vocabularyScreen = document.getElementById('vocabulary-screen');
        const vocabHomeButton = document.getElementById('vocab-home-button');
        const vocabSearch = document.getElementById('vocab-search');
        const vocabFilter = document.getElementById('vocab-filter');
        const vocabularyContainer = document.getElementById('vocabulary-container');
        const totalWordsSpan = document.getElementById('total-words');
        const vocabEmptyState = document.getElementById('vocab-empty-state');
        const homeButton = document.getElementById('home-button');
        const statsButton = document.getElementById('stats-button');
        const subjectHeader = document.getElementById('subject-header');
        const englishInfo = document.getElementById('english-info');
        const englishDifficultyDisplay = document.getElementById('english-difficulty-display');
        const mathInfo = document.getElementById('math-info');
        const mathDifficultyDisplay = document.getElementById('math-difficulty-display');
        const mathScoreDisplay = document.getElementById('math-score-display');
        const problemContainer = document.getElementById('problem-container');
        const feedbackOverlay = document.getElementById('feedback-overlay');
        const feedbackContent = document.getElementById('feedback-content');
        const solutionOverlay = document.getElementById('solution-overlay');
        const solutionContent = document.getElementById('solution-content');
        const closeSolutionOverlay = document.getElementById('close-solution-overlay');
        const solutionText = document.getElementById('solution-text');
        const actionButtons = document.getElementById('action-buttons');
        const startNewWeekButton = document.getElementById('start-new-week-button');
        const weekSetupModal = document.getElementById('week-setup-modal');
        const saveWeekButton = document.getElementById('save-week-button');
        const cancelWeekButton = document.getElementById('cancel-week-button');
        const statsModal = document.getElementById('stats-modal');
        const closeStatsModal = document.getElementById('close-stats-modal');
        const statsContainer = document.getElementById('stats-container');
        const learningSubjectScores = document.getElementById('learning-subject-scores');
        const subjectScoresHome = document.getElementById('subject-scores-home');
        const currentProblemScoreContainer = document.getElementById('current-problem-score-container');
        const saveIndicator = document.getElementById('save-indicator');
        const lastSaveTime = document.getElementById('last-save-time');
        const resetStatsButton = document.getElementById('reset-stats-button');
        const englishLevelSelect = document.getElementById('english-level-select');
        const mathLevelSelect = document.getElementById('math-level-select');
        const homeStatsButton = document.getElementById('home-stats-button');

        // ìƒíƒœ ë³€ìˆ˜ - ì•”í˜¸í™”ëœ ê°’ë“¤
        // ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸ë“¤ (XOR + Base64 ì¸ì½”ë”©)
        const ENCRYPTED_LOGIN_PASSWORD = "U1hAT0VEGBs="; // yrjeon21 encrypted
        const ENCRYPTED_ADMIN_PASSWORD = "fUBZTkhMQQsY"; // Wjsdbfk!2 encrypted  
        const ENCRYPTED_API_KEY = "a2NQS3lTa3gfRmBYEkBhX19aZlhZH1MeRBxYTGt8eBlOXERZGXAe"; // API key encrypted
        
        let currentSessionType = null;
        let englishLevel, consecutiveCorrectEnglish = 0;
        let mathLevel, mathScore = 0, consecutiveCorrectMath, consecutiveIncorrect = 0;
        let consecutiveCorrectKorean, consecutiveIncorrectKorean = 0;
        let isFetching = false;
        let prefetchedEnglishProblem = null;
        let prefetchedKoreanProblem = null;
        let prefetchedMathProblem = null;
        let currentProblem = null;
        
        let weeklyScore, weeklyEnglishScore, weeklyKoreanScore, weeklyMathScore;
        let weekStartDate;
        let weeklyRewards;
        
    let mistakes;
    let savedProblems;
        let stats;
        let vocabulary = []; // Vocabulary notebook storage
        let currentMistakeIndex = 0;
    let currentSavedIndex = 0;
        
        // Initialize save system
        const saveSystem = new YuraSaveSystem();
        
        // ë³€ìˆ˜ ì´ˆê¸°í™” í•¨ìˆ˜ - ê¸°ë³¸ê°’ìœ¼ë¡œë§Œ ì´ˆê¸°í™”
        function initializeVariables() {
            // ì´ˆê¸°í™” ì‹œì—ë§Œ ê¸°ë³¸ê°’ ì„¤ì •
            if (englishLevel === undefined) englishLevel = 5; // FAST ELA Level 5 ê¸°ë³¸ê°’
            if (mathLevel === undefined) mathLevel = 1;
            if (consecutiveCorrectEnglish === undefined) consecutiveCorrectEnglish = 0;
            if (consecutiveCorrectMath === undefined) consecutiveCorrectMath = 0;
            if (consecutiveCorrectKorean === undefined) consecutiveCorrectKorean = 0;
            if (weeklyScore === undefined) weeklyScore = 0;
            if (weeklyEnglishScore === undefined) weeklyEnglishScore = 0;
            if (weeklyKoreanScore === undefined) weeklyKoreanScore = 0;
            if (weeklyMathScore === undefined) weeklyMathScore = 0;
            if (weekStartDate === undefined) weekStartDate = null;
            if (weeklyRewards === undefined) weeklyRewards = [];
            if (mistakes === undefined) mistakes = [];
            if (savedProblems === undefined) savedProblems = [];
            if (stats === undefined) stats = {};
            if (vocabulary === undefined) vocabulary = [];
        }

        // ì €ì¥ í‚¤ ìƒìˆ˜ ì •ì˜
        const STORAGE_KEYS = {
            WEEK_START: 'learningApp_weekStartDate',
            MISTAKES: 'learningApp_mistakes',
            STATS: 'learningApp_stats',
            ENGLISH_LEVEL: 'learningApp_englishLevel',
            MATH_LEVEL: 'learningApp_mathLevel',
            CONSECUTIVE_ENGLISH: 'learningApp_consecutiveEnglish',
            CONSECUTIVE_KOREAN: 'learningApp_consecutiveKorean',
            CONSECUTIVE_MATH: 'learningApp_consecutiveMath',
            WEEKLY_REWARDS: 'learningApp_weeklyRewards',
            WEEKLY_SCORE: 'learningApp_weeklyScore',
            WEEKLY_ENGLISH_SCORE: 'learningApp_weeklyEnglishScore',
            WEEKLY_KOREAN_SCORE: 'learningApp_weeklyKoreanScore',
            WEEKLY_MATH_SCORE: 'learningApp_weeklyMathScore',
            LAST_SAVE: 'learningApp_lastSave',
            SESSION_COUNT: 'learningApp_sessionCount',
            VOCABULARY: 'learningApp_vocabulary'
        };

        // --- ë°ì´í„° ì €ì¥ ë° ë³µì› í•¨ìˆ˜ ---
        function saveAllData() {
            try {
                const dataToSave = {
                    weekStartDate,
                    weeklyRewards,
                    weeklyScore,
                    weeklyEnglishScore,
                    weeklyKoreanScore,
                    weeklyMathScore,
                    englishLevel,
                    mathLevel,
                    consecutiveCorrectEnglish,
                    consecutiveCorrectKorean,
                    consecutiveCorrectMath,
                    mistakes,
                    savedProblems,
                    stats,
                    vocabulary
                };

                // Use new save system with error handling for quota issues
                try {
                    saveSystem.saveToFile(dataToSave);
                    showSaveIndicator();
                    updateLastSaveTime();
                    console.log('ë°ì´í„° ì €ì¥ ì™„ë£Œ:', new Date().toLocaleString());
                    return true;
                } catch (storageError) {
                    if (storageError.name === 'QuotaExceededError') {
                        console.warn('Storage quota exceeded, cleaning up...');
                        // Try to clean up and save again
                        saveSystem.cleanupStorage();
                        saveSystem.saveToFile(dataToSave);
                        showSaveIndicator();
                        updateLastSaveTime();
                        console.log('ë°ì´í„° ì €ì¥ ì™„ë£Œ (ì •ë¦¬ í›„):', new Date().toLocaleString());
                        return true;
                    }
                    throw storageError;
                }
            } catch (e) {
                console.error('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', e);
                if (e.name === 'QuotaExceededError') {
                    alert('ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì˜¤ë˜ëœ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ì •ë¦¬ë©ë‹ˆë‹¤.');
                }
                return false;
            }
        }

        function loadAllData() {
            try {
                console.log('ë°ì´í„° ë¡œë“œ ì‹œì‘...');
                
                // ë¨¼ì € ë³€ìˆ˜ë“¤ì„ ì´ˆê¸°í™” (undefined ì²´í¬ë¡œ ê¸°ë³¸ê°’ ì„¤ì •)
                initializeVariables();
                
                // Load data using new save system
                const savedData = saveSystem.loadLatestData();
                
                if (!savedData) {
                    console.log('ì €ì¥ëœ ë°ì´í„° ì—†ìŒ - ê¸°ë³¸ê°’ ì‚¬ìš©');
                    // Initialize with defaults
                    englishLevel = 1;
                    mathLevel = 1;
                    consecutiveCorrectEnglish = 0;
                    consecutiveCorrectMath = 0;
                    consecutiveCorrectKorean = 0;
                    weeklyScore = 0;
                    weeklyEnglishScore = 0;
                    weeklyKoreanScore = 0;
                    weeklyMathScore = 0;
                    weekStartDate = null;
                    weeklyRewards = [];
                    mistakes = [];
                    initializeStats();
                    return;
                }
                
                // Restore data from saved file
                console.log('ë°ì´í„° ë³µì› ì¤‘...');
                console.log('savedData:', savedData);
                
                weekStartDate = savedData.weekStartDate;
                weeklyRewards = savedData.weeklyRewards || [];
                weeklyScore = savedData.weeklyScore || 0;
                weeklyEnglishScore = savedData.weeklyEnglishScore || 0;
                weeklyKoreanScore = savedData.weeklyKoreanScore || 0;
                weeklyMathScore = savedData.weeklyMathScore || 0;
                englishLevel = savedData.englishLevel || 1;
                mathLevel = savedData.mathLevel || 1;
                consecutiveCorrectEnglish = savedData.consecutiveCorrectEnglish || 0;
                consecutiveCorrectKorean = savedData.consecutiveCorrectKorean || 0;
                consecutiveCorrectMath = savedData.consecutiveCorrectMath || 0;
                mistakes = savedData.mistakes || [];
                savedProblems = savedData.savedProblems || [];
                stats = savedData.stats || saveSystem.getDefaultStats();
                vocabulary = savedData.vocabulary || [];
                
                console.log('Loaded savedProblems:', savedProblems);
                console.log('savedProblems count:', savedProblems ? savedProblems.length : 0);
                
                // Update level selectors
                if (englishLevelSelect) {
                    englishLevelSelect.value = englishLevel.toString();
                }
                if (mathLevelSelect) {
                    mathLevelSelect.value = mathLevel.toString();
                }
                
                updateLastSaveTime();
                
                console.log('ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', {
                    ì£¼ê°„ì ìˆ˜: weeklyScore,
                    ì˜ì–´ì ìˆ˜: weeklyEnglishScore,
                    í•œê¸€ì ìˆ˜: weeklyKoreanScore,
                    ìˆ˜í•™ì ìˆ˜: weeklyMathScore,
                    ì˜ì–´ë ˆë²¨: englishLevel,
                    ìˆ˜í•™ë ˆë²¨: mathLevel,
                    ì˜¤ë‹µìˆ˜: mistakes.length,
                    ë³´ìƒìˆ˜: weeklyRewards.length
                });
            } catch (e) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê°•ì œ ì´ˆê¸°í™”
                englishLevel = 1;
                mathLevel = 1;
                consecutiveCorrectEnglish = 0;
                consecutiveCorrectMath = 0;
                consecutiveCorrectKorean = 0;
                weeklyScore = 0;
                weeklyEnglishScore = 0;
                weeklyKoreanScore = 0;
                weeklyMathScore = 0;
                weekStartDate = null;
                weeklyRewards = [];
                mistakes = [];
                stats = saveSystem.getDefaultStats();
            }
        }

        function clearAllData() {
            saveSystem.clearAllData();
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-blue-100 border border-blue-400 text-blue-700 px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function showSaveIndicator() {
            saveIndicator.classList.remove('hidden');
            setTimeout(() => {
                saveIndicator.classList.add('hidden');
            }, 2000);
        }

        function updateLastSaveTime() {
            const fullData = saveSystem.loadFromLocalStorage();
            if (fullData && fullData.lastUpdated) {
                const date = new Date(fullData.lastUpdated);
                lastSaveTime.textContent = `ë§ˆì§€ë§‰ ì €ì¥: ${date.toLocaleString('ko-KR')}`;
            }
        }

        // ì²« ë¬¸ì œë“¤ ë¯¸ë¦¬ ìƒì„±
        async function prefetchInitialProblems() {
            console.log('ì´ˆê¸° ë¬¸ì œ ë¯¸ë¦¬ ìƒì„± ì‹œì‘...');
            
            // ì˜ì–´ ë¬¸ì œ ë¯¸ë¦¬ ìƒì„±
            fetchProblem('english', englishLevel).then(p => {
                prefetchedEnglishProblem = p;
                console.log('ì˜ì–´ ë¬¸ì œ ë¯¸ë¦¬ ìƒì„± ì™„ë£Œ');
            }).catch(err => {
                console.error('ì˜ì–´ ë¬¸ì œ ë¯¸ë¦¬ ìƒì„± ì‹¤íŒ¨:', err);
            });
            
            // í•œê¸€ ë¬¸ì œ ë¯¸ë¦¬ ìƒì„±
            fetchProblem('korean', mathLevel).then(p => {
                prefetchedKoreanProblem = p;
                console.log('í•œê¸€ ë¬¸ì œ ë¯¸ë¦¬ ìƒì„± ì™„ë£Œ');
            }).catch(err => {
                console.error('í•œê¸€ ë¬¸ì œ ë¯¸ë¦¬ ìƒì„± ì‹¤íŒ¨:', err);
            });
            
            // ìˆ˜í•™ ë¬¸ì œ ë¯¸ë¦¬ ìƒì„±
            fetchProblem('math', mathLevel).then(p => {
                prefetchedMathProblem = p;
                console.log('ìˆ˜í•™ ë¬¸ì œ ë¯¸ë¦¬ ìƒì„± ì™„ë£Œ');
            }).catch(err => {
                console.error('ìˆ˜í•™ ë¬¸ì œ ë¯¸ë¦¬ ìƒì„± ì‹¤íŒ¨:', err);
            });
        }

        // --- AI ë¬¸ì œ ìƒì„± ë¡œì§ (Gemini API) ---
        function getAdaptivePrompt(subject, level) {
            if (subject === 'english') {
                // Adjust categories based on level
                const categoriesByLevel = {
                    1: ['Vocabulary', 'Main Idea'],
                    2: ['Vocabulary', 'Main Idea', 'Advanced Vocabulary'],
                    3: ['Advanced Vocabulary', 'Main Idea', 'Text Evidence'],
                    4: ['Advanced Vocabulary', 'Main Idea', 'Text Evidence', 'Author\'s Purpose'],
                    5: [
                        'Informational Text',
                        'Informational Text',  // Double weight
                        'Reading Across Genres',
                        'Reading Across Genres',  // Double weight
                        'Advanced Vocabulary',
                        'Advanced Vocabulary',  // Double weight
                        'Main Idea',
                        'Author\'s Purpose',
                        'Text Evidence',
                        'Compare and Contrast'
                    ]
                };
                const categories = categoriesByLevel[level] || categoriesByLevel[5];
                // Original categories array for backward compatibility
                const fallbackCategories = [
                    'Informational Text',
                    'Informational Text',  // Double weight
                    'Reading Across Genres',
                    'Reading Across Genres',  // Double weight
                    'Advanced Vocabulary',
                    'Advanced Vocabulary',  // Double weight
                    'Main Idea',
                    'Author\'s Purpose',
                    'Text Evidence',
                    'Compare and Contrast'
                ];
                const category = categories[Math.floor(Math.random() * categories.length)];
                console.log(`ì„ íƒëœ ì˜ì–´ ë¶„ì•¼: ${category}`);
                
                // Different prompts based on category for FAST ELA Level 5
                if (category === 'Informational Text') {
                    return `You are an English teacher preparing a student for FAST ELA Level ${level}. Create one multiple-choice reading comprehension question based on an informational text passage. 
                    Level requirements: ${level === 5 ? 'Use complex sentence structures, advanced vocabulary (grade 5-6), and sophisticated topics' : level === 4 ? 'Use moderate complexity with grade 4 vocabulary' : level === 3 ? 'Use simple sentences with grade 3 vocabulary' : 'Use basic sentences with grade 2 vocabulary'}.
                    The passage should be about science, history, or technology. ${level === 5 ? 'Include a 7-10 sentence passage with rich detail, multiple paragraphs allowed, complex ideas, and advanced vocabulary' : level >= 4 ? 'Include a 5-7 sentence passage' : 'Include a 3-4 sentence passage'}. Ask about key details, cause and effect, or text structure. 
                    Provide the response in a single JSON object with keys: "q" (passage + question), "options" (array of 4 strings), "a" (the correct answer), "category", "solution" (explanation), and "vocabulary" (array of 3-5 important words from the passage with format: [{"word": "example", "korean": "ì˜ˆì‹œ", "definition": "a sample or model", "example": "This is an example sentence."}]).`;
                } else if (category === 'Reading Across Genres') {
                    return `You are an English teacher preparing a student for FAST ELA Level 5. Create one multiple-choice question that compares different text genres. Present two text excerpts (3-5 sentences each) from different genres (e.g., fiction vs. non-fiction, poetry vs. informational, narrative vs. persuasive). Use rich, detailed language appropriate for grade 5 readers. Ask about genre characteristics, author's purpose, or how information is presented differently. Provide the response in a single JSON object with keys: "q" (excerpts + question), "options" (array of 4 strings), "a" (the correct answer), "category", and "solution" (explanation of genre differences).`;
                } else if (category === 'Advanced Vocabulary') {
                    return `You are an English teacher preparing a student for FAST ELA Level ${level}. Create one multiple-choice vocabulary question.
                    Level requirements: ${level === 5 ? 'Use academic and domain-specific words (grade 5-6 level)' : level === 4 ? 'Use grade 4 vocabulary' : level === 3 ? 'Use grade 3 vocabulary' : 'Use basic grade 2 vocabulary'}.
                    Present the word in a meaningful context sentence, then ask about its meaning, synonym, antonym, or usage. Focus on words commonly found in science, social studies, or literature texts. 
                    Provide the response in a single JSON object with keys: "q" (context sentence + question), "options" (array of 4 strings), "a" (the correct answer), "category", "solution" (explanation), and "vocabulary" (array with the target word and 2-3 related words: [{"word": "example", "korean": "ì˜ˆì‹œ", "definition": "a sample or model", "example": "This is an example sentence."}]).`;
                } else if (category === 'Author\'s Purpose') {
                    return `You are an English teacher preparing a student for FAST ELA Level 5. Create one multiple-choice question about author's purpose. Present a detailed passage (5-7 sentences) with clear purpose and sophisticated language appropriate for grade 5. Ask why the author wrote it (to inform, persuade, entertain, or explain). Provide the response in a single JSON object with keys: "q" (passage + question), "options" (array of 4 strings), "a" (the correct answer), "category", and "solution" (explanation with text evidence).`;
                } else if (category === 'Text Evidence') {
                    return `You are an English teacher preparing a student for FAST ELA Level 5. Create one multiple-choice question requiring students to cite text evidence. Present a substantive passage (6-8 sentences) with multiple details and complex ideas. Ask which sentence or detail best supports a given statement or conclusion. Provide the response in a single JSON object with keys: "q" (passage + question), "options" (array of 4 strings), "a" (the correct answer), "category", and "solution" (explanation of why that evidence is strongest).`;
                } else if (category === 'Compare and Contrast') {
                    return `You are an English teacher preparing a student for FAST ELA Level 5. Create one multiple-choice question about comparing and contrasting. Present detailed information about two related topics, characters, or ideas (6-8 sentences total, with rich descriptions and multiple points of comparison). Ask about similarities or differences. Provide the response in a single JSON object with keys: "q" (comparison text + question), "options" (array of 4 strings), "a" (the correct answer), "category", and "solution" (explanation of the comparison).`;
                } else {
                    // Main Idea (existing)
                    return `You are an English teacher preparing a student for FAST ELA Level ${level}. Create one multiple-choice question about the main idea. 
                    Level requirements: ${level === 5 ? 'Use complex paragraphs with advanced vocabulary' : level === 4 ? 'Use moderate complexity' : level === 3 ? 'Use simple paragraphs' : 'Use basic paragraphs'}.
                    Present a detailed paragraph (${level === 5 ? '7-9' : level >= 4 ? '5-6' : '3-4'} sentences) about a topic appropriate for the reading level. ${level === 5 ? 'Include supporting details, examples, and sophisticated vocabulary.' : ''} Ask for the main idea or best summary. 
                    Provide the response in a single JSON object with keys: "q" (paragraph + question), "options" (array of 4 strings), "a" (the correct answer), "category", "solution" (explanation), and "vocabulary" (array of 3-5 key words: [{"word": "example", "korean": "ì˜ˆì‹œ", "definition": "a sample or model", "example": "This is an example sentence."}]).`;
                }
            } else if (subject === 'korean') {
                const categories = ['ë§ì¶¤ë²•', 'ì†ë‹´', 'ì–´íœ˜'];
                let weightedCategories = [];

                categories.forEach(cat => {
                    const stat = stats.korean[cat];
                    let weight;
                    if (!stat || stat.attempted < 3) {
                        weight = 3; // Give a neutral weight if not enough data
                    } else {
                        const accuracy = (stat.correct / stat.attempted) * 100;
                        // Lower accuracy = higher weight. Weight between 1 and 10.
                        weight = Math.round(Math.max(1, (105 - accuracy) / 10));
                    }
                    for (let i = 0; i < weight; i++) {
                        weightedCategories.push(cat);
                    }
                });

                if (weightedCategories.length === 0) weightedCategories = categories;

                const category = weightedCategories[Math.floor(Math.random() * weightedCategories.length)];
                console.log(`ì„ íƒëœ í•œê¸€ ë¶„ì•¼ (ê°€ì¤‘ì¹˜ ì ìš©): ${category}`);
                return `You are a Korean language teacher for a 10-year-old student in Korea. Create one multiple-choice Korean language question about '${category}'. The question should be suitable for a 4th grader. Avoid overly common proverbs like 'í‹°ëŒ ëª¨ì•„ íƒœì‚°'. Provide the response in a single JSON object with keys: "q" (Korean question), "options" (array of 4 strings), "a" (the correct answer), "category", and "solution" (short Korean explanation why the answer is correct). Ensure options are plausible and creative.`;
            } else { // math
                return `You are a math teacher for a 10-year-old Korean 4th grade student. Create one math problem for difficulty level ${level} out of 10. Provide the response in a single JSON object with keys: "q_ko" (Korean question), "q_en" (English translation), "a" (numerical answer), "options" (array of 4 plausible numbers), and "solution" (short Korean explanation with steps).`;
            }
        }
        
        // ğŸ” ë³´ì•ˆ ì•”í˜¸í™” í•´ë… í•¨ìˆ˜
        // XOR + Base64 ì•”í˜¸í™” ë°©ì‹ ì‚¬ìš© (ë¯¼ê° ì •ë³´ ë³´í˜¸)
        function decryptValue(encrypted) {
            try {
                // Base64 ë””ì½”ë”© í›„ XOR í•´ë…
                const decoded = atob(encrypted);
                let result = '';
                for (let i = 0; i < decoded.length; i++) {
                    result += String.fromCharCode(decoded.charCodeAt(i) ^ 42); // XOR with security key
                }
                return result;
            } catch (e) {
                console.error('ğŸš¨ Security decryption failed:', e);
                return null;
            }
        }
        
        async function fetchProblem(subject, level) {
            const apiKey = decryptValue(ENCRYPTED_API_KEY);
            if (!apiKey) {
                 return { error: "API í‚¤ ë””ì½”ë”© ì‹¤íŒ¨.<br>ê°œë°œìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”." };
            }

            const prompt = getAdaptivePrompt(subject, level);
            console.log("Generated Prompt:", prompt);
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error('API Error Body:', errorBody);
                    throw new Error(`API call failed with status: ${response.status}. ${errorBody?.error?.message || ''}`);
                }
                const result = await response.json();
                console.log("API Raw Response:", result);
                const jsonText = result.candidates[0].content.parts[0].text;
                const problem = JSON.parse(jsonText);
                problem.isKorean = subject === 'korean';
                problem.isEnglish = subject === 'english';
                
                // Ensure answer format consistency
                if (subject === 'korean' || subject === 'english') {
                    // Normalize Korean answers
                    if (problem.a) problem.a = problem.a.toString().trim().normalize('NFC');
                    if (problem.options) {
                        problem.options = problem.options.map(opt => opt.toString().trim().normalize('NFC'));
                    }
                } else { // math
                    // Ensure math answers are numbers
                    if (problem.a !== undefined) {
                        const numAnswer = parseFloat(problem.a);
                        if (!isNaN(numAnswer)) problem.a = numAnswer;
                    }
                    if (problem.options) {
                        problem.options = problem.options.map(opt => {
                            const numOpt = typeof opt === 'number' ? opt : parseFloat((opt + '').replace(/,/g, ''));
                            return isNaN(numOpt) ? opt : numOpt;
                        });
                    }
                }
                
                console.log('Generated problem:', {
                    subject,
                    question: problem.q_ko || problem.q,
                    answer: problem.a,
                    options: problem.options
                });
                
                return problem;
            } catch (error) {
                console.error("AI Generation Error:", error);
                return { error: `ë¬¸ì œ ìƒì„±ì— ì‹¤íŒ¨í–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. (ì˜¤ë¥˜: ${error.message})` };
            }
        }

        async function loadProblem() {
            if (isFetching) return;
            isFetching = true;

            problemContainer.innerHTML = `<div class="text-center"><div class="loader"></div><p class="text-gray-600">AIê°€ ìƒˆë¡œìš´ ë¬¸ì œë¥¼ ë§Œë“¤ê³  ìˆì–´ìš”...</p></div>`;
            currentProblemScoreContainer.innerHTML = '';
            actionButtons.innerHTML = '';

            let problemToRender = null;
            
            // í˜„ì¬ ì„¸ì…˜ì— ë§ëŠ” ì˜ˆë¹„ ë¬¸ì œ ì‚¬ìš©
            if (currentSessionType === 'english') {
                problemToRender = prefetchedEnglishProblem;
                prefetchedEnglishProblem = null;
            } else if (currentSessionType === 'korean') {
                problemToRender = prefetchedKoreanProblem;
                prefetchedKoreanProblem = null;
            } else if (currentSessionType === 'math') {
                problemToRender = prefetchedMathProblem;
                prefetchedMathProblem = null;
            }

            if (!problemToRender) {
                problemToRender = await fetchProblem(currentSessionType, currentSessionType === 'english' ? englishLevel : mathLevel);
            }
            
            // ë‹¤ìŒ ë¬¸ì œ ë¯¸ë¦¬ ì¤€ë¹„
            if (currentSessionType === 'english') {
                fetchProblem('english', englishLevel).then(p => { prefetchedEnglishProblem = p; });
            } else if (currentSessionType === 'korean') {
                fetchProblem('korean', mathLevel).then(p => { prefetchedKoreanProblem = p; });
            } else if (currentSessionType === 'math') {
                fetchProblem('math', mathLevel).then(p => { prefetchedMathProblem = p; });
            }

            if (problemToRender && !problemToRender.error) {
                currentProblem = problemToRender;
                if (currentProblem.isEnglish) {
                    renderEnglishProblem(currentProblem);
                } else if (currentProblem.isKorean) {
                    renderKoreanProblem(currentProblem);
                } else {
                    renderMathProblem(currentProblem);
                }
            } else {
                problemContainer.innerHTML = `<p class="text-red-500 text-center">${problemToRender.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}</p>`;
                if (!problemToRender.error.includes("API í‚¤")) {
                    actionButtons.innerHTML = `<button id="retry-generation" class="btn btn-blue">ë‹¤ì‹œ ì‹œë„</button>`;
                    document.getElementById('retry-generation').onclick = loadProblem;
                }
            }
            isFetching = false;
        }

        // --- í•µì‹¬ ë¡œì§: ì£¼ê°„ ëª©í‘œ ë° ì ìˆ˜ ê´€ë¦¬ ---
        function initializeApp() {
            console.log('ì•± ì´ˆê¸°í™” ì‹œì‘');
            
            // Clean up storage first to prevent quota issues
            try {
                saveSystem.cleanupStorage();
            } catch (e) {
                console.warn('Storage cleanup failed:', e);
            }
            
            // ë°ì´í„° ë¡œë“œ (ë‚´ë¶€ì—ì„œ initializeVariables í˜¸ì¶œë¨)
            loadAllData();
            
            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ - localStorage ì‚¬ìš©ìœ¼ë¡œ ë³€ê²½
            const isLoggedIn = localStorage.getItem('learningApp_isLoggedIn') === 'true';
            if (isLoggedIn) {
                console.log('ìë™ ë¡œê·¸ì¸ - ë°ì´í„° ë³µì› ì™„ë£Œ');
                console.log('í˜„ì¬ ìƒíƒœ:', {
                    ì£¼ê°„ì ìˆ˜: weeklyScore,
                    ì˜ì–´ì ìˆ˜: weeklyEnglishScore,
                    í•œê¸€ì ìˆ˜: weeklyKoreanScore,
                    ìˆ˜í•™ì ìˆ˜: weeklyMathScore,
                    ì˜ì–´ë ˆë²¨: englishLevel,
                    ìˆ˜í•™ë ˆë²¨: mathLevel,
                    ì˜¤ë‹µìˆ˜: mistakes ? mistakes.length : 0
                });
                // ë¡œê·¸ì¸ ìƒíƒœë©´ í™ˆ í™”ë©´ í‘œì‹œí•˜ê³  UI ì—…ë°ì´íŠ¸
                showHomeScreen();
                updateHomeScreenUI();
            } else {
                console.log('ë¡œê·¸ì¸ í•„ìš”');
            }
        }

        function initializeStats() {
            stats = saveSystem.getDefaultStats();
            if (!stats.english) {
                stats.english = {};
            }
        }

        function addScore(points, subject) {
            // Don't add scores for review or saved problem sessions
            if (currentSessionType !== 'review' && currentSessionType !== 'saved') {
                weeklyScore = Math.max(0, weeklyScore + points);
                if (subject === 'english') {
                    weeklyEnglishScore = Math.max(0, weeklyEnglishScore + points);
                } else if (subject === 'korean') {
                    weeklyKoreanScore = Math.max(0, weeklyKoreanScore + points);
                } else { 
                     weeklyMathScore = Math.max(0, weeklyMathScore + points);
                }
                
                saveAllData();
                updateHomeScreenUI();
                updateLearningScreenScoresDisplay();
            }
        }

        function openWeekSetupModal(message = '') {
            document.getElementById('modal-message').textContent = message;
            weekSetupModal.querySelectorAll('.reward-desc').forEach(input => input.value = '');
            const goalInputs = weekSetupModal.querySelectorAll('.reward-goal-english, .reward-goal-korean, .reward-goal-math');
            const defaultGoals = [100, 250, 500];
            goalInputs.forEach((input, index) => {
                 input.value = defaultGoals[Math.floor(index/3)];
            });
            weekSetupModal.classList.remove('hidden');
        }

        function saveWeeklyGoals() {
            const modalMessage = document.getElementById('modal-message');
            modalMessage.textContent = '';
            const newRewards = [];
            // Select only actual reward rows (skip header) by targeting rows that contain inputs
            const rewardDivs = document.querySelectorAll('#reward-inputs .modal-grid');
            let isValid = true, hasInput = false;

            rewardDivs.forEach(div => {
                const descEl = div.querySelector('.reward-desc');
                const enEl = div.querySelector('.reward-goal-english');
                const koEl = div.querySelector('.reward-goal-korean');
                const maEl = div.querySelector('.reward-goal-math');
                if (!descEl || !enEl || !koEl || !maEl) return; // safety
                const desc = descEl.value.trim();
                const goal_en = enEl.value.trim();
                const goal_ko = koEl.value.trim();
                const goal_ma = maEl.value.trim();
                const anyFilled = desc || goal_en || goal_ko || goal_ma;
                if (anyFilled) {
                    // If partially filled -> invalid
                    if (!(desc && goal_en && goal_ko && goal_ma)) {
                        isValid = false;
                        return;
                    }
                    hasInput = true;
                    newRewards.push({
                        desc,
                        goal_en: Number(goal_en),
                        goal_ko: Number(goal_ko),
                        goal_ma: Number(goal_ma)
                    });
                }
            });

            if (!isValid) {
                modalMessage.textContent = 'ëª¨ë“  ì¹¸(ë³´ìƒ, ì˜ì–´, í•œê¸€, ìˆ˜í•™)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }
            if (!hasInput) {
                modalMessage.textContent = 'í•˜ë‚˜ ì´ìƒì˜ ë³´ìƒì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.';
                return;
            }

            // Determine if we should reset scores (new week or no existing weekStartDate)
            const oneWeekInMs = 7 * 24 * 60 * 60 * 1000;
            const shouldResetScores = !weekStartDate || (Date.now() - weekStartDate > oneWeekInMs);

            weeklyRewards = newRewards;
            weekStartDate = Date.now();

            if (shouldResetScores) {
                weeklyScore = 0;
                weeklyEnglishScore = 0;
                weeklyKoreanScore = 0;
                weeklyMathScore = 0;
                consecutiveCorrectEnglish = 0;
                consecutiveCorrectMath = 0;
                consecutiveCorrectKorean = 0;
            }

            if (saveAllData()) {
                updateHomeScreenUI();
                weekSetupModal.classList.add('hidden');
                showNotification('ì´ë²ˆ ì£¼ ë³´ìƒì´ ì €ì¥ë˜ì—ˆì–´ìš”!');
            }
        }

        // --- UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
        function updateHomeScreenUI() {
            document.getElementById('weekly-score').textContent = weeklyScore;
            subjectScoresHome.innerHTML = `
                <div class="text-sm"><span class="font-bold text-purple-600">ì˜ì–´</span> ${weeklyEnglishScore}ì </div>
                <div class="text-sm"><span class="font-bold text-cyan-600">í•œê¸€</span> ${weeklyKoreanScore}ì </div>
                <div class="text-sm"><span class="font-bold text-yellow-600">ìˆ˜í•™</span> ${weeklyMathScore}ì </div>`;
            updateWeeklyGoalsDisplay();
            updateWeekDurationDisplay();
            
            // Update level selectors
            if (englishLevelSelect) {
                englishLevelSelect.value = englishLevel.toString();
            }
            if (mathLevelSelect) {
                mathLevelSelect.value = mathLevel.toString();
            }
        }
        
        function updateLearningScreenScoresDisplay() {
            learningSubjectScores.innerHTML = `
                <div class="text-purple-500 bg-purple-100 px-4 py-1 rounded-full">ì˜ì–´: ${weeklyEnglishScore}ì </div>
                <div class="text-cyan-500 bg-cyan-100 px-4 py-1 rounded-full">í•œê¸€: ${weeklyKoreanScore}ì </div>
                <div class="text-yellow-600 bg-yellow-100 px-4 py-1 rounded-full">ìˆ˜í•™: ${weeklyMathScore}ì </div>`;
        }
        
        function updateWeekDurationDisplay() {
            const display = document.getElementById('week-duration');
            const daysDisplay = document.getElementById('days-remaining');
            
            if (weekStartDate) {
                const startDate = new Date(weekStartDate);
                const endDate = new Date(weekStartDate + 7 * 24 * 60 * 60 * 1000);
                const now = new Date();
                const daysRemaining = Math.ceil((endDate - now) / (24 * 60 * 60 * 1000));
                
                display.textContent = `${startDate.toLocaleDateString()} ~ ${endDate.toLocaleDateString()}`;
                
                if (daysRemaining > 0) {
                    daysDisplay.textContent = `${daysRemaining}ì¼ ë‚¨ìŒ`;
                } else if (daysRemaining === 0) {
                    daysDisplay.textContent = 'ì˜¤ëŠ˜ì´ ë§ˆì§€ë§‰ ë‚ !';
                } else {
                    daysDisplay.textContent = 'ê¸°ê°„ ì¢…ë£Œë¨ - ìƒˆ ì£¼ë¥¼ ì‹œì‘í•˜ì„¸ìš”!';
                }
            } else { 
                display.textContent = 'ìƒˆë¡œìš´ ì£¼ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.'; 
                daysDisplay.textContent = '';
            }
        }
        
        function updateWeeklyGoalsDisplay() {
            const container = document.getElementById('weekly-goals-container');
            container.innerHTML = '';
            if (!weeklyRewards || weeklyRewards.length === 0) { 
                container.innerHTML = '<p class="text-gray-500 text-center">ì„¤ì •ëœ ë³´ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>'; 
                return;
            }
            const sortedRewards = weeklyRewards.sort((a, b) => (a.goal_en + a.goal_ko + a.goal_ma) - (b.goal_en + b.goal_ko + b.goal_ma));
            sortedRewards.forEach(reward => {
                const achieved = weeklyEnglishScore >= reward.goal_en && weeklyKoreanScore >= reward.goal_ko && weeklyMathScore >= reward.goal_ma;
                const goalEl = document.createElement('div');
                goalEl.className = `flex justify-between items-center p-3 rounded-lg transition-all duration-300 ${achieved ? 'bg-green-100' : 'bg-gray-100'}`;
                goalEl.innerHTML = `
                    <div>
                        <span class="font-bold ${achieved ? 'text-green-600 line-through' : 'text-gray-700'}">${reward.desc}</span> 
                        <span class="text-sm ${achieved ? 'text-green-500' : 'text-gray-500'}">(ì˜ì–´ ${reward.goal_en}ì  / í•œê¸€ ${reward.goal_ko}ì  / ìˆ˜í•™ ${reward.goal_ma}ì )</span>
                    </div>
                    <div class="text-2xl">${achieved ? 'âœ…' : 'â¬œ'}</div>`;
                container.appendChild(goalEl);
            });
        }
        
        // --- í™”ë©´ ì „í™˜ ë¡œì§ ---
        function startSession(sessionType) {
            currentSessionType = sessionType;
            homeScreen.classList.add('hidden');
            learningScreen.classList.remove('hidden');
            updateLearningScreenScoresDisplay();
            
            // í™”ë©´ ì´ˆê¸°í™”
            problemContainer.innerHTML = '';
            actionButtons.innerHTML = '';
            currentProblemScoreContainer.innerHTML = '';
            
            // ì´ì „ ì„¸ì…˜ ë°ì´í„° ì •ë¦¬
            currentProblem = null;
            isFetching = false;
            
            if (sessionType === 'english') {
                subjectHeader.textContent = 'ì˜ì–´ ê³µë¶€';
                englishInfo.classList.remove('hidden');
                mathInfo.classList.add('hidden');
                // Update English difficulty display
                englishDifficultyDisplay.textContent = `ë‚œì´ë„: ${englishLevel}`;
                loadProblem();
            } else if (sessionType === 'korean') {
                subjectHeader.textContent = 'ğŸ“ í•œê¸€ ê³µë¶€';
                englishInfo.classList.add('hidden');
                mathInfo.classList.add('hidden');
                consecutiveIncorrectKorean = 0;
                loadProblem();
            } else if (sessionType === 'math') {
                subjectHeader.textContent = 'ğŸ§® ìˆ˜í•™ ê³µë¶€';
                englishInfo.classList.add('hidden');
                mathInfo.classList.remove('hidden');
                resetMathState();
                loadProblem();
            } else if (sessionType === 'review') {
                subjectHeader.textContent = 'ğŸ“– ì˜¤ë‹µ ë‹¤ì‹œ í’€ê¸°';
                englishInfo.classList.add('hidden');
                mathInfo.classList.add('hidden');
                startMistakeReview();
            } else if (sessionType === 'saved') {
                subjectHeader.textContent = 'ğŸ”– ì €ì¥í•œ ë¬¸ì œ ë‹¤ì‹œ í’€ê¸°';
                englishInfo.classList.add('hidden');
                mathInfo.classList.add('hidden');
                startSavedReview();
            }
        }
        
        function showHomeScreen() {
            loginScreen.classList.add('hidden');
            learningScreen.classList.add('hidden');
            homeScreen.classList.remove('hidden');
            
            // í™ˆ í™”ë©´ìœ¼ë¡œ ëŒì•„ì˜¬ ë•Œ ì²« ë¬¸ì œë“¤ ë¯¸ë¦¬ ì¤€ë¹„
            prefetchInitialProblems();
            
            // UI ì—…ë°ì´íŠ¸ ë¨¼ì € ì‹¤í–‰
            updateHomeScreenUI();
            
            // ì£¼ê°„ ì²´í¬ëŠ” ë°ì´í„° ë¡œë“œê°€ ì™„ë£Œëœ í›„ì—ë§Œ (setTimeoutìœ¼ë¡œ ì§€ì—°)
            setTimeout(() => {
                const oneWeekInMs = 7 * 24 * 60 * 60 * 1000;
                if (!weekStartDate) {
                    openWeekSetupModal('ìƒˆë¡œìš´ ì£¼ë¥¼ ì‹œì‘í•˜ê³  ì´ë²ˆ ì£¼ ë³´ìƒì„ ì •í•´ì£¼ì„¸ìš”!');
                } else if (Date.now() - weekStartDate > oneWeekInMs) {
                    openWeekSetupModal('ì¼ì£¼ì¼ì´ ì§€ë‚¬ì–´ìš”! ìƒˆë¡œìš´ ì£¼ë¥¼ ì‹œì‘í•˜ì„¸ìš”.');
                }
            }, 100);
        }

        // --- ë¬¸ì œ ë Œë”ë§ ë° ì±„ì  ë¡œì§ ---
        function renderEnglishProblem(problem) {
            console.log("Rendering English Problem:", problem);
            const baseScore = 10;
            const bonus = consecutiveCorrectEnglish * 2;
            currentProblemScoreContainer.innerHTML = `ì´ë²ˆ ë¬¸ì œ ì ìˆ˜: ${baseScore}ì  + ì—°ì† ì •ë‹µ ë³´ë„ˆìŠ¤ ${bonus}ì  = <span class="text-blue-600">${baseScore + bonus}ì </span>`;

            // Ensure options exist and are valid
            if (!problem.options || !Array.isArray(problem.options)) {
                console.error('Invalid options for English problem:', problem);
                problem.options = ['Error: No options', 'Error: No options', 'Error: No options', 'Error: No options'];
            }
            
            const shuffledOptions = [...problem.options].sort(() => Math.random() - 0.5);
            // Standardized text size for all options
            let optionsHtml = shuffledOptions.map(option => {
                // Handle null or undefined options
                if (option === null || option === undefined) {
                    console.warn('Null or undefined option found, using placeholder');
                    option = 'Error: Invalid option';
                }
                const normalizedOption = String(option).trim().normalize('NFC');
                return `<button class="english-option btn btn-blue w-full p-4 text-base">${normalizedOption}</button>`;
            }).join('');
            
            // Standardized text size for all question types
            let questionHTML = `<p class="english-question-text text-gray-800 mb-6 min-h-[6rem]">${problem.q.replace(/\n/g, '<br>')}</p>`;

            // Get category description for FAST ELA Level 5
            let categoryDesc = '';
            switch(problem.category) {
                case 'Informational Text':
                    categoryDesc = 'ì •ë³´ í…ìŠ¤íŠ¸ ì½ê¸°';
                    break;
                case 'Reading Across Genres':
                    categoryDesc = 'ì¥ë¥´ë³„ ì½ê¸°';
                    break;
                case 'Advanced Vocabulary':
                    categoryDesc = 'ê³ ê¸‰ ì–´íœ˜';
                    break;
                case 'Author\'s Purpose':
                    categoryDesc = 'ì‘ê°€ì˜ ì˜ë„';
                    break;
                case 'Text Evidence':
                    categoryDesc = 'í…ìŠ¤íŠ¸ ì¦ê±°';
                    break;
                case 'Compare and Contrast':
                    categoryDesc = 'ë¹„êµì™€ ëŒ€ì¡°';
                    break;
                case 'Main Idea':
                    categoryDesc = 'ì¤‘ì‹¬ ìƒê°';
                    break;
                default:
                    categoryDesc = problem.category;
            }

            problemContainer.innerHTML = `
                <div class="w-full">
                    <div class="mb-4 flex items-center gap-2">
                        <span class="text-sm font-bold text-white bg-purple-500 px-3 py-1 rounded-full">${problem.category}</span>
                        <span class="text-sm text-gray-600">${categoryDesc}</span>
                        ${englishLevel === 5 ? '<span class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded-full">FAST ELA L5</span>' : ''}
                    </div>
                    ${questionHTML}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${optionsHtml}</div>
                </div>`;
                
            document.querySelectorAll('.english-option').forEach(button => {
                button.addEventListener('click', (event) => {
                    console.log("English option clicked:", event.target.textContent);
                    checkEnglishAnswer(problem, event.target.textContent);
                });
            });
        }

        // Function to add vocabulary from problems
        function addVocabularyFromProblem(problem) {
            if (problem.vocabulary && Array.isArray(problem.vocabulary)) {
                let newWordsAdded = 0;
                problem.vocabulary.forEach(word => {
                    // Check if word already exists (case-insensitive)
                    const existingIndex = vocabulary.findIndex(v => 
                        v.word.toLowerCase() === word.word.toLowerCase()
                    );
                    if (existingIndex === -1) {
                        vocabulary.push({
                            ...word,
                            dateAdded: new Date().toISOString(),
                            fromCategory: problem.category
                        });
                        newWordsAdded++;
                    }
                });
                if (newWordsAdded > 0) {
                    saveAllData();
                    console.log(`Vocabulary: ${newWordsAdded} new words added (${problem.vocabulary.length - newWordsAdded} duplicates skipped)`);
                } else {
                    console.log('Vocabulary: All words already exist in vocabulary');
                }
            }
        }

        function checkEnglishAnswer(problem, userAnswer) {
            console.log("checkEnglishAnswer called with:", problem, userAnswer);
            const normalizeString = (str) => {
                if (!str) return '';
                return str.toString().trim().normalize('NFC');
            };
            
            const normalizedUserAnswer = normalizeString(userAnswer);
            const normalizedCorrectAnswer = normalizeString(problem.a);
            
            const isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
            if (currentSessionType !== 'review') {
                updateStats('english', problem.category, isCorrect);
                // Add vocabulary from this problem
                addVocabularyFromProblem(problem);
            }
            
            document.querySelectorAll('.english-option').forEach(btn => btn.disabled = true);
            
            if (isCorrect) {
                const points = 10 + (consecutiveCorrectEnglish * 2);
                addScore(points, 'english');
                feedbackContent.innerHTML = `<div class="flex items-center justify-center gap-4 text-green-500">
                    <img src="roopy_succ.jpeg" alt="Success" class="w-32 h-32 rounded-lg">
                    <span>Correct! ğŸ‰ (+${points} points)</span>
                </div>`;
                consecutiveCorrectEnglish++;
                // Review ëª¨ë“œì—ì„œë„ ì˜¤ë‹µì„ ì‚­ì œí•˜ì§€ ì•Šê³  ìœ ì§€ (ìš”ì²­ì‚¬í•­)
                if (currentSessionType === 'review') {
                    currentMistakeIndex++; // ë‹¤ìŒ ì¸ë±ìŠ¤ë¡œë§Œ ì´ë™
                    // ìœ ì§€ë˜ë¯€ë¡œ save í•„ìš” ì—†ìŒ
                }
            } else {
                const basePenalty = 5;
                const penalty = basePenalty;
                addScore(-penalty, 'english');
                feedbackContent.innerHTML = `<div class="flex items-center justify-center gap-4 text-red-500">
                    <img src="roopy_fail.png" alt="Fail" class="w-32 h-32 rounded-lg">
                    <div>
                        <div>Try again! ë‹¤ì‹œ í•œë²ˆ ìƒê°í•´ë³´ì„¸ìš”!</div>
                        <div class="text-lg mt-2">(-${penalty} points)</div>
                    </div>
                </div>`;
                consecutiveCorrectEnglish = 0;
                
                if (currentSessionType !== 'review') { 
                    mistakes.push(problem); 
                    saveMistakes(); 
                } else { 
                    currentMistakeIndex++; 
                }
            }
            
            feedbackOverlay.classList.remove('hidden');
            saveAllData();
            
            actionButtons.innerHTML = `
                <button id="save-problem" class="btn btn-save px-6 py-3 text-lg">â­ Save Problem</button>
                <button id="next-problem" class="btn btn-next px-8 py-3 text-lg">ğŸ¯ Next Problem</button>
                ${problem.solution ? `<button id="show-solution" class="btn btn-solution px-6 py-3 text-lg">ğŸ’¡ View Solution</button>` : ''}`;
            document.getElementById('save-problem').onclick = () => saveCurrentProblemForLater(problem);
            
            if (problem.solution) {
                document.getElementById('show-solution').onclick = () => {
                    if (confirm('Are you sure you want to see the solution?\n\nâš ï¸ You will lose 2 points.')) {
                        if (currentSessionType !== 'review' && currentSessionType !== 'saved') {
                            addScore(-2, 'english');
                        }
                        solutionText.innerHTML = `<div class="font-bold text-xl mb-4">ğŸ§  Solution</div><div class="text-lg">${problem.solution.replace(/(\d\.)/g, '<br>$1')}</div>`;
                        solutionOverlay.classList.remove('hidden');
                        document.getElementById('show-solution').disabled = true;
                        document.getElementById('show-solution').textContent = 'Solution Viewed';
                    }
                };
            }
            
            document.getElementById('next-problem').onclick = () => {
                feedbackOverlay.classList.add('hidden');
                if (currentSessionType === 'review') {
                    loadMistakeProblem();
                } else if (currentSessionType === 'saved') {
                    currentSavedIndex++;
                    loadSavedProblem();
                } else {
                    loadProblem();
                }
            };
        }

        function renderKoreanProblem(problem) {
            const baseScore = 10;
            const bonus = consecutiveCorrectKorean * 2;
            currentProblemScoreContainer.innerHTML = `ì´ë²ˆ ë¬¸ì œ ì ìˆ˜: ${baseScore}ì  + ì—°ì† ì •ë‹µ ë³´ë„ˆìŠ¤ ${bonus}ì  = <span class="text-blue-600">${baseScore + bonus}ì </span>`;

            const shuffledOptions = [...problem.options].sort(() => Math.random() - 0.5);
            let optionsHtml = shuffledOptions.map(option => {
                const normalizedOption = option.toString().trim().normalize('NFC');
                return `<button class="korean-option btn btn-blue w-full p-4 text-xl">${normalizedOption}</button>`;
            }).join('');
            
            problemContainer.innerHTML = `
                <div class="w-full">
                    <div class="mb-4">
                        <span class="text-sm font-bold text-white bg-cyan-500 px-3 py-1 rounded-full">${problem.category}</span>
                    </div>
                    <p class="text-2xl text-gray-800 mb-6 min-h-[6rem]">${problem.q}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${optionsHtml}</div>
                </div>`;
                
            document.querySelectorAll('.korean-option').forEach(button => {
                button.onclick = () => {
                    const selectedAnswer = button.textContent;
                    checkKoreanAnswer(problem, selectedAnswer);
                };
            });
        }

        function checkKoreanAnswer(problem, userAnswer) {
            // Normalize strings for comparison - trim whitespace and normalize Unicode
            const normalizeString = (str) => {
                if (!str) return '';
                return str.toString().trim().normalize('NFC');
            };
            
            const normalizedUserAnswer = normalizeString(userAnswer);
            const normalizedCorrectAnswer = normalizeString(problem.a);
            
            console.log('Korean answer check:', {
                userAnswer: normalizedUserAnswer,
                correctAnswer: normalizedCorrectAnswer,
                isMatch: normalizedUserAnswer === normalizedCorrectAnswer
            });
            
            const isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;
            if (currentSessionType !== 'review') {
                updateStats('korean', problem.category, isCorrect);
            }
            
            document.querySelectorAll('.korean-option').forEach(btn => btn.disabled = true);
            
            if (isCorrect) {
                const points = 10 + (consecutiveCorrectKorean * 2);
                addScore(points, 'korean');
                feedbackContent.innerHTML = `<div class="flex items-center justify-center gap-4 text-green-500">
                    <img src="roopy_succ.jpeg" alt="Success" class="w-32 h-32 rounded-lg">
                    <span>ì •ë‹µì…ë‹ˆë‹¤! ğŸ‰ (+${points}ì )</span>
                </div>`;
                consecutiveCorrectKorean++;
                consecutiveIncorrectKorean = 0;
                // Review ëª¨ë“œì—ì„œë„ ì‚­ì œí•˜ì§€ ì•ŠìŒ
                if (currentSessionType === 'review') {
                    currentMistakeIndex++;
                }
            } else {
                const basePenalty = 5;
                const penalty = basePenalty + consecutiveIncorrectKorean;
                addScore(-penalty, 'korean');
                feedbackContent.innerHTML = `<div class="flex items-center justify-center gap-4 text-red-500">
                    <img src="roopy_fail.png" alt="Fail" class="w-32 h-32 rounded-lg">
                    <div>
                        <div>ë‹¤ì‹œ í•œë²ˆ ìƒê°í•´ë³´ì„¸ìš”!</div>
                        <div class="text-lg mt-2">(-${penalty}ì )</div>
                    </div>
                </div>`;
                consecutiveCorrectKorean = 0;
                consecutiveIncorrectKorean++;
                
                if (currentSessionType !== 'review') { 
                    mistakes.push(problem); 
                    saveMistakes(); 
                } else { 
                    currentMistakeIndex++; 
                }
            }
            
            feedbackOverlay.classList.remove('hidden');
            saveAllData();
            
            actionButtons.innerHTML = `
                <button id="save-problem" class="btn btn-save px-6 py-3 text-lg">â­ ë¬¸ì œ ì €ì¥</button>
                <button id="next-problem" class="btn btn-next px-8 py-3 text-lg">ğŸ¯ ë‹¤ìŒ ë¬¸ì œ</button>
                ${problem.solution ? `<button id="show-solution" class="btn btn-solution px-6 py-3 text-lg">ğŸ’¡ í’€ì´ ë³´ê¸°</button>` : ''}`;
            document.getElementById('save-problem').onclick = () => saveCurrentProblemForLater(problem);
            
            if (problem.solution) {
                document.getElementById('show-solution').onclick = () => {
                    if (confirm('í’€ì´ë¥¼ ë³´ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜: í’€ì´ë¥¼ ë³´ë©´ 2ì ì´ ê°ì ë©ë‹ˆë‹¤.')) {
                        if (currentSessionType !== 'review' && currentSessionType !== 'saved') {
                            addScore(-2, 'korean');
                        }
                        solutionText.innerHTML = `<div class="font-bold text-xl mb-4">ğŸ§  í’€ì´</div><div class="text-lg">${problem.solution.replace(/(\d\.)/g, '<br>$1')}</div>`;
                        solutionOverlay.classList.remove('hidden');
                        document.getElementById('show-solution').disabled = true;
                        document.getElementById('show-solution').textContent = 'í’€ì´ í™•ì¸ë¨';
                    }
                };
            }
            
            document.getElementById('next-problem').onclick = () => {
                feedbackOverlay.classList.add('hidden');
                if (currentSessionType === 'review') {
                    loadMistakeProblem();
                } else if (currentSessionType === 'saved') {
                    currentSavedIndex++;
                    loadSavedProblem();
                } else {
                    loadProblem();
                }
            };
        }
        
        function resetMathState() {
            mathScore = 0;
            consecutiveIncorrect = 0;
            updateMathInfo();
        }
        
        function updateMathInfo() {
            mathDifficultyDisplay.textContent = `ë‚œì´ë„: ${mathLevel}`;
            mathScoreDisplay.textContent = `ë§ì€ ê°œìˆ˜: ${mathScore}`;
        }

        function renderMathProblem(problem) {
            const baseScore = 5 + mathLevel;
            const bonus = consecutiveCorrectMath * 2;
            currentProblemScoreContainer.innerHTML = `ì´ë²ˆ ë¬¸ì œ ì ìˆ˜: ${baseScore}ì  + ì—°ì† ì •ë‹µ ë³´ë„ˆìŠ¤ ${bonus}ì  = <span class="text-blue-600">${baseScore + bonus}ì </span>`;
            
            const formatNum = (n) => {
                if (typeof n !== 'number' || !isFinite(n)) return n;
                return Number.isInteger(n) ? n.toString() : n.toFixed(Math.abs(n) < 1 ? 2 : 1).replace(/\.0$/, '');
            };
            const shuffledOptions = [...problem.options].map(o => (typeof o === 'number' ? o : parseFloat((o + '').replace(/,/g, '')))).sort(() => Math.random() - 0.5);
            const isWordProblem = problem.q_en.split(' ').length > 5;
            const questionHtml = isWordProblem ? 
                `<p class="text-2xl text-gray-800 mb-2">${problem.q_ko}</p><p class="text-base text-gray-500 mb-8">${problem.q_en}</p>` : 
                `<p class="text-5xl font-bold text-gray-800 mb-2">${problem.q_ko}</p><p class="text-xl text-gray-500 mb-8">${problem.q_en}</p>`;
                
            problemContainer.innerHTML = `
                <div class="text-center w-full">
                    ${questionHtml}
                    <div class="grid grid-cols-2 gap-4 options-grid">
                        ${shuffledOptions.map(option => {
                            const numVal = typeof option === 'number' ? option : parseFloat((option + '').replace(/,/g, ''));
                            const displayValue = Number.isFinite(numVal) ? formatNum(numVal) : option;
                            return `<button class="math-option btn btn-blue w-full p-4 text-2xl" data-value="${numVal}">${displayValue}</button>`;
                        }).join('')}
                    </div>
                </div>`;
                
            document.querySelectorAll('.math-option').forEach(b => { 
                b.onclick = () => {
                    const selectedAnswer = b.getAttribute('data-value');
                    console.log('Math button clicked:', { text: b.textContent, value: selectedAnswer });
                    checkMathAnswer(problem, selectedAnswer);
                };
            });
        }
        
        function checkMathAnswer(problem, userAnswer) {
            // Handle different number formats and ensure proper comparison
            const normalizeNumber = (num) => {
                if (num === null || num === undefined || num === '') return NaN;
                const parsed = parseFloat(num.toString().replace(/,/g, ''));
                return isNaN(parsed) ? NaN : parsed;
            };
            
            const normalizedUserAnswer = normalizeNumber(userAnswer);
            const normalizedCorrectAnswer = normalizeNumber(problem.a);
            
            console.log('Math answer check:', {
                userAnswer: normalizedUserAnswer,
                correctAnswer: normalizedCorrectAnswer,
                original: { user: userAnswer, correct: problem.a }
            });
            
            // Check if both are valid numbers and calculate correctness
            let isCorrect = false;
            if (isNaN(normalizedUserAnswer) || isNaN(normalizedCorrectAnswer)) {
                console.warn('Invalid number comparison:', { user: normalizedUserAnswer, correct: normalizedCorrectAnswer });
                isCorrect = false;
            } else {
                // Use appropriate tolerance for floating point comparison
                const tolerance = Math.max(0.01, Math.abs(normalizedCorrectAnswer) * 0.001);
                isCorrect = Math.abs(normalizedUserAnswer - normalizedCorrectAnswer) < tolerance;
            }
            
            if (currentSessionType !== 'review') {
                updateStats('math', `level_${mathLevel}`, isCorrect);
            }

            document.querySelectorAll('.math-option').forEach(btn => btn.disabled = true);
            
            if (isCorrect) {
                const points = 5 + mathLevel + (consecutiveCorrectMath * 2);
                addScore(points, 'math');
                feedbackContent.innerHTML = `<div class="flex items-center justify-center gap-4 text-green-500">
                    <img src="roopy_succ.jpeg" alt="Success" class="w-32 h-32 rounded-lg">
                    <span>ì •ë‹µì…ë‹ˆë‹¤! ğŸ‘ (+${points}ì )</span>
                </div>`;
                if (currentSessionType === 'review') {
                    currentMistakeIndex++; // ì‚­ì œí•˜ì§€ ì•Šê³  ì§„í–‰
                } else {
                    mathScore++; 
                    consecutiveCorrectMath++; 
                    consecutiveIncorrect = 0;
                    
                    if (consecutiveCorrectMath > 0 && consecutiveCorrectMath % 3 === 0 && mathLevel < 10) {
                        mathLevel++;
                        const feedbackSpan = feedbackContent.querySelector('span');
                        if (feedbackSpan) {
                            feedbackSpan.textContent += ' ë‚œì´ë„ê°€ ì˜¬ëì–´ìš”!';
                        }
                    }
                }
            } else {
                // Enhanced penalty system: lower difficulty = higher penalty
                // Level 1-3: base 15-10, Level 4-6: base 10-8, Level 7-10: base 8-5
                let basePenalty;
                if (mathLevel <= 3) {
                    basePenalty = 18 - mathLevel; // Level 1=17, 2=16, 3=15
                } else if (mathLevel <= 6) {
                    basePenalty = 14 - mathLevel; // Level 4=10, 5=9, 6=8
                } else {
                    basePenalty = 15 - mathLevel; // Level 7=8, 8=7, 9=6, 10=5
                }
                
                // Consecutive mistakes multiply penalty (exponential growth)
                const consecutivePenalty = Math.pow(2, Math.min(consecutiveIncorrect, 3)); // 1, 2, 4, 8 (max)
                const penalty = basePenalty * consecutivePenalty;
                addScore(-penalty, 'math');
                feedbackContent.innerHTML = `<div class="flex items-center justify-center gap-4 text-red-500">
                    <img src="roopy_fail.png" alt="Fail" class="w-32 h-32 rounded-lg">
                    <div>
                        <div>ë‹¤ì‹œ ê³„ì‚°í•´ë³´ì„¸ìš”!</div>
                        <div class="text-lg mt-2">(-${penalty}ì )</div>
                    </div>
                </div>`;
                
                if (currentSessionType !== 'review') {
                    mistakes.push(problem);
                    saveMistakes();
                    consecutiveIncorrect++; 
                    consecutiveCorrectMath = 0;
                    
                    if (consecutiveIncorrect >= 2 && mathLevel > 1) { 
                        mathLevel--;
                        consecutiveIncorrect = 0;
                        const feedbackSpan = feedbackContent.querySelector('span');
                        if (feedbackSpan) {
                            feedbackSpan.textContent += ' ë‚œì´ë„ê°€ ë‚®ì•„ì¡Œì–´ìš”.';
                        }
                    }
                } else { 
                    currentMistakeIndex++; 
                }
            }
            
            feedbackOverlay.classList.remove('hidden');
            saveAllData();
            if (currentSessionType !== 'review') updateMathInfo();
            
            actionButtons.innerHTML = `
                <button id="save-problem" class="btn btn-save px-6 py-3 text-lg">â­ ë¬¸ì œ ì €ì¥</button>
                <button id="next-problem" class="btn btn-next px-8 py-3 text-lg">ğŸ¯ ë‹¤ìŒ ë¬¸ì œ</button>
                ${problem.solution ? `<button id="show-solution" class="btn btn-solution px-6 py-3 text-lg">ğŸ’¡ í’€ì´ ë³´ê¸°</button>` : ''}`;
            document.getElementById('save-problem').onclick = () => saveCurrentProblemForLater(problem);
            
            if (problem.solution) {
                document.getElementById('show-solution').onclick = () => {
                    if (confirm('í’€ì´ë¥¼ ë³´ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜: í’€ì´ë¥¼ ë³´ë©´ 2ì ì´ ê°ì ë©ë‹ˆë‹¤.')) {
                        if (currentSessionType !== 'review' && currentSessionType !== 'saved') {
                            addScore(-2, 'math');
                        }
                        solutionText.innerHTML = `<div class="font-bold text-xl mb-4">ğŸ§  í’€ì´</div><div class="text-lg">${problem.solution.replace(/(\d\.)/g, '<br>$1')}</div>`;
                        solutionOverlay.classList.remove('hidden');
                        document.getElementById('show-solution').disabled = true;
                        document.getElementById('show-solution').textContent = 'í’€ì´ í™•ì¸ë¨';
                    }
                };
            }
            
            document.getElementById('next-problem').onclick = () => {
                feedbackOverlay.classList.add('hidden');
                if (currentSessionType === 'review') {
                    loadMistakeProblem();
                } else if (currentSessionType === 'saved') {
                    currentSavedIndex++;
                    loadSavedProblem();
                } else {
                    loadProblem();
                }
            };
        }

        // --- ì˜¤ë‹µ ë…¸íŠ¸ ë¡œì§ ---
        function startMistakeReview() {
            currentProblemScoreContainer.innerHTML = '';
            if (mistakes.length === 0) {
                problemContainer.innerHTML = `<p class="text-2xl text-gray-700 text-center">ğŸ‰<br>ì˜¤ë‹µ ë…¸íŠ¸ê°€ ë¹„ì–´ìˆì–´ìš”. ì•„ì£¼ ì˜í•˜ê³  ìˆì–´ìš”!</p>`;
                actionButtons.innerHTML = ''; 
                return;
            }
            
            // Show mistakes count and management buttons
            problemContainer.innerHTML = `
                <div class="text-center">
                    <p class="text-2xl text-gray-700 mb-4">ğŸ“– ì˜¤ë‹µ ë…¸íŠ¸</p>
                    <p class="text-lg text-gray-600 mb-6">ì´ ${mistakes.length}ê°œì˜ ì˜¤ë‹µì´ ìˆìŠµë‹ˆë‹¤.</p>
                    <div class="flex gap-4 justify-center">
                        <button id="start-mistake-practice" class="btn btn-blue px-6 py-3 text-lg">ğŸ“ ì˜¤ë‹µ í’€ê¸°</button>
                        <button id="view-mistakes-list" class="btn btn-purple px-6 py-3 text-lg">ğŸ“‹ ëª©ë¡ ë³´ê¸°</button>
                        <button id="clear-mistakes" class="btn btn-red px-6 py-3 text-lg">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
                    </div>
                </div>`;
            
            document.getElementById('start-mistake-practice').onclick = () => {
                mistakes.sort(() => Math.random() - 0.5);
                currentMistakeIndex = 0;
                loadMistakeProblem();
            };
            
            document.getElementById('view-mistakes-list').onclick = () => {
                showMistakesList();
            };
            
            document.getElementById('clear-mistakes').onclick = () => {
                clearMistakes();
            };
        }
        
        function loadMistakeProblem() {
            actionButtons.innerHTML = '';
            
            if (currentMistakeIndex >= mistakes.length) {
                problemContainer.innerHTML = `<p class="text-2xl text-gray-700 text-center">âœ¨<br>ì˜¤ë‹µ ë…¸íŠ¸ë¥¼ ëª¨ë‘ ë‹¤ì‹œ í’€ì—ˆì–´ìš”! ì •ë§ ëŒ€ë‹¨í•´ìš”!</p>`; 
                return;
            }
            
            const problem = mistakes[currentMistakeIndex];
            currentProblem = problem;
            prefetchedEnglishProblem = null;
            prefetchedKoreanProblem = null;
            prefetchedMathProblem = null;
            
            if (problem.isEnglish) {
                renderEnglishProblem(problem);
            } else if (problem.isKorean) {
                renderKoreanProblem(problem);
            } else {
                renderMathProblem(problem);
            }
        }
        
        function saveMistakes() {
            // Mistakes are saved as part of saveAllData
            saveAllData();
        }

        // --- ì €ì¥í•œ ë¬¸ì œ ë‹¤ì‹œ í’€ê¸° ---
        function startSavedReview() {
            console.log('startSavedReview called');
            console.log('savedProblems:', savedProblems);
            console.log('savedProblems length:', savedProblems ? savedProblems.length : 'undefined');
            
            currentProblemScoreContainer.innerHTML = '';
            
            if (!savedProblems || savedProblems.length === 0) {
                console.log('No saved problems found');
                problemContainer.innerHTML = `<p class="text-2xl text-gray-700 text-center">ğŸ”–<br>ì €ì¥í•œ ë¬¸ì œê°€ ì•„ì§ ì—†ì–´ìš”. ë¬¸ì œë¥¼ í’€ê³  'ë¬¸ì œ ì €ì¥'ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.</p>`;
                actionButtons.innerHTML = '';
                return;
            }
            
            // Show saved problems count and management buttons
            problemContainer.innerHTML = `
                <div class="text-center">
                    <p class="text-2xl text-gray-700 mb-4">ğŸ”– ì €ì¥í•œ ë¬¸ì œ</p>
                    <p class="text-lg text-gray-600 mb-6">ì´ ${savedProblems.length}ê°œì˜ ë¬¸ì œê°€ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
                    <div class="flex gap-4 justify-center">
                        <button id="start-saved-practice" class="btn btn-blue px-6 py-3 text-lg">ğŸ“ ë¬¸ì œ í’€ê¸°</button>
                        <button id="view-saved-list" class="btn btn-purple px-6 py-3 text-lg">ğŸ“‹ ëª©ë¡ ë³´ê¸°</button>
                        <button id="clear-saved-problems" class="btn btn-red px-6 py-3 text-lg">ğŸ—‘ï¸ ëª¨ë‘ ì‚­ì œ</button>
                    </div>
                </div>`;
            
            document.getElementById('start-saved-practice').onclick = () => {
                console.log('Shuffling saved problems...');
                savedProblems.sort(() => Math.random() - 0.5);
                currentSavedIndex = 0;
                console.log('Starting to load first saved problem...');
                loadSavedProblem();
            };
            
            document.getElementById('view-saved-list').onclick = () => {
                showSavedProblemsList();
            };
            
            document.getElementById('clear-saved-problems').onclick = () => {
                clearSavedProblems();
            };
        }

        function loadSavedProblem() {
            console.log('loadSavedProblem called, currentSavedIndex:', currentSavedIndex);
            console.log('savedProblems:', savedProblems);
            
            actionButtons.innerHTML = '';
            solutionOverlay.classList.add('hidden');
            
            if (currentSavedIndex >= savedProblems.length) {
                problemContainer.innerHTML = `<p class="text-2xl text-gray-700 text-center">âœ…<br>ì €ì¥í•œ ë¬¸ì œë¥¼ ëª¨ë‘ í’€ì—ˆì–´ìš”!</p>`;
                return;
            }
            
            const problem = savedProblems[currentSavedIndex];
            console.log('Loading saved problem:', problem);
            
            if (!problem) {
                console.error('Problem is undefined at index:', currentSavedIndex);
                problemContainer.innerHTML = `<p class="text-2xl text-red-600 text-center">âš ï¸<br>ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }
            
            currentProblem = problem;
            
            if (problem.isEnglish) {
                console.log('Rendering English problem');
                renderEnglishProblem(problem);
            } else if (problem.isKorean) {
                console.log('Rendering Korean problem');
                renderKoreanProblem(problem);
            } else {
                console.log('Rendering Math problem');
                renderMathProblem(problem);
            }
        }

        function saveCurrentProblemForLater(problem) {
            try {
                console.log('Saving problem:', problem);
                console.log('Current savedProblems before save:', savedProblems);
                
                const snapshot = JSON.parse(JSON.stringify(problem));
                // Fix for English problems - preserve string options
                if (snapshot.isEnglish) {
                    // English options should remain as strings
                    if (Array.isArray(snapshot.options)) {
                        snapshot.options = snapshot.options.map(o => String(o));
                    }
                } else if (!snapshot.isKorean) {
                    // Math problems - convert to numbers
                    if (snapshot.a !== undefined) snapshot.a = parseFloat(snapshot.a);
                    if (Array.isArray(snapshot.options)) {
                        snapshot.options = snapshot.options.map(o => {
                            if (typeof o === 'number') return o;
                            const cleaned = String(o).replace(/,/g, '');
                            const parsed = parseFloat(cleaned);
                            return isNaN(parsed) ? o : parsed;
                        });
                    }
                }
                
                savedProblems.push(snapshot);
                console.log('Problem added to savedProblems. New count:', savedProblems.length);
                console.log('savedProblems after save:', savedProblems);
                
                saveAllData();
                showNotification('ë¬¸ì œê°€ ì €ì¥ë˜ì—ˆì–´ìš”! ğŸ”–');
            } catch (e) {
                console.error('Save problem failed', e);
                alert('ë¬¸ì œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // Show list of saved problems
        function showSavedProblemsList() {
            let listHTML = `
                <div class="max-h-[60vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4">ğŸ“‹ ì €ì¥ëœ ë¬¸ì œ ëª©ë¡</h3>
                    <div class="space-y-2">`;
            
            savedProblems.forEach((problem, index) => {
                let type = problem.isEnglish ? 'ğŸ‡ºğŸ‡¸ ì˜ì–´' : problem.isKorean ? 'ğŸ“ í•œê¸€' : 'ğŸ§® ìˆ˜í•™';
                let preview = problem.q ? problem.q.substring(0, 50) + '...' : 'ë¬¸ì œ ë‚´ìš© ì—†ìŒ';
                
                listHTML += `
                    <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg">
                        <div class="flex-1">
                            <span class="font-bold mr-2">${type}</span>
                            <span class="text-sm text-gray-600">${preview}</span>
                        </div>
                        <button onclick="deleteSavedProblem(${index})" class="text-red-500 hover:text-red-700 text-xl">âŒ</button>
                    </div>`;
            });
            
            listHTML += `
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button id="back-to-saved-menu" class="btn btn-gray px-6 py-2">ë’¤ë¡œ ê°€ê¸°</button>
                </div>`;
            
            problemContainer.innerHTML = listHTML;
            actionButtons.innerHTML = '';
            
            document.getElementById('back-to-saved-menu').onclick = () => {
                startSavedReview();
            };
        }

        // Delete a specific saved problem
        function deleteSavedProblem(index) {
            if (confirm('ì´ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                savedProblems.splice(index, 1);
                saveAllData();
                showNotification('ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                showSavedProblemsList();
            }
        }

        // Clear all saved problems
        function clearSavedProblems() {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ì €ì¥ëœ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
                savedProblems = [];
                saveAllData();
                showNotification('ëª¨ë“  ì €ì¥ëœ ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                startSavedReview();
            }
        }

        // Make deleteSavedProblem globally accessible
        window.deleteSavedProblem = deleteSavedProblem;

        // Show list of mistakes
        function showMistakesList() {
            let listHTML = `
                <div class="max-h-[60vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4">ğŸ“– ì˜¤ë‹µ ëª©ë¡</h3>
                    <div class="space-y-2">`;
            
            mistakes.forEach((problem, index) => {
                let type = problem.isEnglish ? 'ğŸ‡ºğŸ‡¸ ì˜ì–´' : problem.isKorean ? 'ğŸ“ í•œê¸€' : 'ğŸ§® ìˆ˜í•™';
                let preview = problem.q ? problem.q.substring(0, 50) + '...' : 'ë¬¸ì œ ë‚´ìš© ì—†ìŒ';
                
                listHTML += `
                    <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg">
                        <div class="flex-1">
                            <span class="font-bold mr-2">${type}</span>
                            <span class="text-sm text-gray-600">${preview}</span>
                        </div>
                        <button onclick="deleteMistake(${index})" class="text-red-500 hover:text-red-700 text-xl">âŒ</button>
                    </div>`;
            });
            
            listHTML += `
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button id="back-to-mistakes-menu" class="btn btn-gray px-6 py-2">ë’¤ë¡œ ê°€ê¸°</button>
                </div>`;
            
            problemContainer.innerHTML = listHTML;
            actionButtons.innerHTML = '';
            
            document.getElementById('back-to-mistakes-menu').onclick = () => {
                startMistakeReview();
            };
        }

        // Delete a specific mistake
        function deleteMistake(index) {
            if (confirm('ì´ ì˜¤ë‹µì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                mistakes.splice(index, 1);
                saveAllData();
                showNotification('ì˜¤ë‹µì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                showMistakesList();
            }
        }

        // Clear all mistakes with password protection
        function clearMistakes() {
            // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            const adminPassword = prompt('ğŸ” ê´€ë¦¬ì ì¸ì¦\n\nì˜¤ë‹µ ë…¸íŠ¸ ì´ˆê¸°í™”ëŠ” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\nê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (!adminPassword) {
                alert('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const correctAdminPassword = decryptValue(ENCRYPTED_ADMIN_PASSWORD);
            if (adminPassword !== correctAdminPassword) {
                alert('âŒ ì˜ëª»ëœ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.\n\nâš ï¸ ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ ì´ ì‹œë„ê°€ ê¸°ë¡ë©ë‹ˆë‹¤.');
                console.warn('Unauthorized admin access attempt for mistakes reset at:', new Date().toISOString());
                return;
            }
            
            if (confirm('âš ï¸ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ë¨\n\nì •ë§ë¡œ ëª¨ë“  ì˜¤ë‹µì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nğŸ“– ì‚­ì œë  ë°ì´í„°:\n- ëª¨ë“  ì˜¤ë‹µ ê¸°ë¡\n- í‹€ë¦° ë¬¸ì œë“¤\n\nğŸš¨ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
                mistakes = [];
                saveAllData();
                showNotification('ëª¨ë“  ì˜¤ë‹µì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                console.log('Admin mistakes reset completed at:', new Date().toISOString());
                startMistakeReview();
            }
        }

        // Make deleteMistake globally accessible
        window.deleteMistake = deleteMistake;

        // --- í†µê³„ ë¡œì§ ---
        function updateStats(subject, key, isCorrect) {
            if (!stats[subject]) {
                stats[subject] = {};
            }
            if (!stats[subject][key]) {
                stats[subject][key] = { attempted: 0, correct: 0 };
            }
            stats[subject][key].attempted++;
            if (isCorrect) {
                stats[subject][key].correct++;
            }
            // Stats are saved as part of saveAllData
            saveAllData();
        }
        
        function showStatsModal() {
            renderStats();
            statsModal.classList.remove('hidden');
        }
        
        function renderStats() {
            let html = ``;
            
            // ì˜ì–´ í†µê³„
            html += `<div class="mb-6">
                <h3 class="text-xl font-bold mb-3 text-purple-600">ğŸ‡ºğŸ‡¸ ì˜ì–´ í†µê³„</h3>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <div class="grid grid-cols-4 gap-4 text-center font-bold text-gray-600 border-b pb-2 mb-2">
                        <span>ë¶„ì•¼</span>
                        <span>í‘¼ ë¬¸ì œ</span>
                        <span>ë§ì€ ê°œìˆ˜</span>
                        <span>ì •ë‹µë¥ </span>
                    </div>`;
                    
            Object.keys(stats.english).forEach(key => {
                const s = stats.english[key];
                const accuracy = s.attempted > 0 ? ((s.correct / s.attempted) * 100).toFixed(0) : 0;
                html += `
                    <div class="grid grid-cols-4 gap-4 text-center items-center py-1">
                        <span class="font-bold text-left">${key}</span>
                        <span>${s.attempted}</span>
                        <span>${s.correct}</span>
                        <span class="font-bold text-lg ${accuracy >= 80 ? 'text-green-600' : 'text-orange-500'}">${accuracy}%</span>
                    </div>`;
            });
            
            html += `</div></div>`;

            // í•œê¸€ í†µê³„
            html += `<div class="mb-6">
                <h3 class="text-xl font-bold mb-3 text-cyan-600">ğŸ“ í•œê¸€ í†µê³„</h3>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <div class="grid grid-cols-4 gap-4 text-center font-bold text-gray-600 border-b pb-2 mb-2">
                        <span>ë¶„ì•¼</span>
                        <span>í‘¼ ë¬¸ì œ</span>
                        <span>ë§ì€ ê°œìˆ˜</span>
                        <span>ì •ë‹µë¥ </span>
                    </div>`;
                    
            Object.keys(stats.korean).forEach(key => {
                const s = stats.korean[key];
                const accuracy = s.attempted > 0 ? ((s.correct / s.attempted) * 100).toFixed(0) : 0;
                html += `
                    <div class="grid grid-cols-4 gap-4 text-center items-center py-1">
                        <span class="font-bold text-left">${key}</span>
                        <span>${s.attempted}</span>
                        <span>${s.correct}</span>
                        <span class="font-bold text-lg ${accuracy >= 80 ? 'text-green-600' : 'text-orange-500'}">${accuracy}%</span>
                    </div>`;
            });
            
            html += `</div></div>`;
            
            // ìˆ˜í•™ í†µê³„
            html += `<div>
                <h3 class="text-xl font-bold mb-3 text-yellow-600">ğŸ§® ìˆ˜í•™ í†µê³„</h3>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <div class="grid grid-cols-4 gap-4 text-center font-bold text-gray-600 border-b pb-2 mb-2">
                        <span>ë‚œì´ë„</span>
                        <span>í‘¼ ë¬¸ì œ</span>
                        <span>ë§ì€ ê°œìˆ˜</span>
                        <span>ì •ë‹µë¥ </span>
                    </div>`;
                    
            Object.keys(stats.math)
                .sort((a, b) => parseInt(a.split('_')[1]) - parseInt(b.split('_')[1]))
                .forEach(key => {
                    const s = stats.math[key];
                    if (s.attempted === 0) return;
                    const level = key.split('_')[1];
                    const accuracy = s.attempted > 0 ? ((s.correct / s.attempted) * 100).toFixed(0) : 0;
                    html += `
                        <div class="grid grid-cols-4 gap-4 text-center items-center py-1">
                            <span class="font-bold text-left">ë ˆë²¨ ${level}</span>
                            <span>${s.attempted}</span>
                            <span>${s.correct}</span>
                            <span class="font-bold text-lg ${accuracy >= 80 ? 'text-green-600' : 'text-orange-500'}">${accuracy}%</span>
                        </div>`;
                });
                
            html += `</div></div>`;
            
            statsContainer.innerHTML = html;
        }

        function resetStats() {
            // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            const adminPassword = prompt('ğŸ” ê´€ë¦¬ì ì¸ì¦\n\ní†µê³„ ì´ˆê¸°í™”ëŠ” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\nê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (!adminPassword) {
                alert('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const correctAdminPassword = decryptValue(ENCRYPTED_ADMIN_PASSWORD);
            if (adminPassword !== correctAdminPassword) {
                alert('âŒ ì˜ëª»ëœ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ì…ë‹ˆë‹¤.\n\nâš ï¸ ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ ì´ ì‹œë„ê°€ ê¸°ë¡ë©ë‹ˆë‹¤.');
                console.warn('Unauthorized admin access attempt at:', new Date().toISOString());
                return;
            }
            
            if (confirm('âš ï¸ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ë¨\n\nì •ë§ë¡œ ëª¨ë“  í•™ìŠµ í†µê³„ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nğŸ“Š ì‚­ì œë  ë°ì´í„°:\n- ëª¨ë“  ê³¼ëª©ë³„ í†µê³„\n- ì •ë‹µë¥  ê¸°ë¡\n- ë¬¸ì œë³„ ì‹œë„ íšŸìˆ˜\n\nğŸš¨ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
                initializeStats();
                saveAllData();
                renderStats();
                alert('âœ… ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ëª¨ë“  í†µê³„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nìƒˆë¡œìš´ í•™ìŠµ ê¸°ë¡ì´ ì‹œì‘ë©ë‹ˆë‹¤.');
                console.log('Admin stats reset completed at:', new Date().toISOString());
            }
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        closeSolutionOverlay.addEventListener('click', () => solutionOverlay.classList.add('hidden'));

        feedbackOverlay.addEventListener('click', () => feedbackOverlay.classList.add('hidden'));

        loginButton.addEventListener('click', () => {
            const correctPassword = decryptValue(ENCRYPTED_LOGIN_PASSWORD);
            if (passwordInput.value === correctPassword) {
                localStorage.setItem('learningApp_isLoggedIn', 'true');
                
                // ë¡œê·¸ì¸ ì‹œ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ìµœì‹  ìƒíƒœ ë°˜ì˜
                loadAllData();
                
                showHomeScreen();
                updateHomeScreenUI();
                
                console.log('ë¡œê·¸ì¸ ì„±ê³µ - ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
            } else {
                loginError.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ë§ì§€ ì•Šì•„ìš”!';
                passwordInput.value = '';
            }
        });
        
        passwordInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                loginButton.click();
            }
        });

        // --- Vocabulary Functions ---
        function showVocabularyScreen() {
            homeScreen.classList.add('hidden');
            learningScreen.classList.add('hidden');
            vocabularyScreen.classList.remove('hidden');
            displayVocabulary();
        }

        function displayVocabulary(searchTerm = '', filterCategory = 'all') {
            vocabularyContainer.innerHTML = '';
            totalWordsSpan.textContent = vocabulary.length;
            
            if (vocabulary.length === 0) {
                vocabEmptyState.classList.remove('hidden');
                vocabularyContainer.classList.add('hidden');
                return;
            }
            
            vocabEmptyState.classList.add('hidden');
            vocabularyContainer.classList.remove('hidden');
            
            // Filter vocabulary
            let filteredVocab = vocabulary.filter(word => {
                const matchesSearch = searchTerm === '' || 
                    word.word.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (word.korean && word.korean.includes(searchTerm)) ||
                    (word.definition && word.definition.toLowerCase().includes(searchTerm.toLowerCase()));
                
                const matchesCategory = filterCategory === 'all' || word.fromCategory === filterCategory;
                
                return matchesSearch && matchesCategory;
            });
            
            // Sort by date added (newest first)
            filteredVocab.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
            
            // Display vocabulary cards
            filteredVocab.forEach((word, index) => {
                const card = document.createElement('div');
                card.className = 'bg-gradient-to-br from-purple-50 to-blue-50 p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow';
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-2xl font-bold text-purple-700">${word.word}</h3>
                        <button onclick="deleteVocabulary(${vocabulary.indexOf(word)})" 
                                class="text-red-500 hover:text-red-700 text-xl">âŒ</button>
                    </div>
                    <div class="mb-2">
                        <span class="text-lg font-semibold text-gray-700">í•œê¸€:</span>
                        <span class="text-lg text-gray-600">${word.korean || 'ë²ˆì—­ ì—†ìŒ'}</span>
                    </div>
                    <div class="mb-3">
                        <div class="text-sm font-semibold text-gray-700 mb-1">Definition:</div>
                        <div class="text-gray-600">${word.definition || 'No definition'}</div>
                    </div>
                    ${word.example ? `
                    <div class="mb-2">
                        <div class="text-sm font-semibold text-gray-700 mb-1">Example:</div>
                        <div class="text-gray-600 italic">"${word.example}"</div>
                    </div>` : ''}
                    <div class="mt-3 flex justify-between items-center">
                        <span class="text-xs text-gray-500">${word.fromCategory || 'General'}</span>
                        <span class="text-xs text-gray-400">${new Date(word.dateAdded).toLocaleDateString()}</span>
                    </div>
                `;
                
                vocabularyContainer.appendChild(card);
            });
            
            if (filteredVocab.length === 0) {
                vocabularyContainer.innerHTML = '<p class="text-center text-gray-500 col-span-2">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }
        
        function deleteVocabulary(index) {
            if (confirm('ì´ ë‹¨ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                vocabulary.splice(index, 1);
                saveAllData();
                displayVocabulary(vocabSearch.value, vocabFilter.value);
            }
        }
        
        // Make deleteVocabulary globally accessible
        window.deleteVocabulary = deleteVocabulary;

    </script>
</body>
</html>